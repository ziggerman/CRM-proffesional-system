# AEL CRM ‚Äî –ü–æ–≤–Ω–∏–π –ø–ª–∞–Ω –ø–æ–∫—Ä–∞—â–µ–Ω—å —Ç–∞ —Ä–æ–∑–≤–∏—Ç–∫—É —Å–∏—Å—Ç–µ–º–∏

> **–ö–æ–Ω—Ç–µ–∫—Å—Ç**: –î–æ–∫—É–º–µ–Ω—Ç —Ñ—ñ–∫—Å—É—î –≤—Å—ñ –≤–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ –ø–æ—Ç–æ—á–Ω–æ—ó —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó, –ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è —Ç–∞ roadmap —Ä–æ–∑–≤–∏—Ç–∫—É —Å–∏—Å—Ç–µ–º–∏ –≤—ñ–¥ MVP –¥–æ production-ready CRM. –†–æ–∑–¥—ñ–ª–∏ –≤–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω—ñ –∑–∞ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–æ–º.

---

## ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó (2026-02-23)

–ù–∏–∂—á–µ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ, —â–æ –≤–∂–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –≤ Copilot —ñ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–æ –≤ –∞–∫—Ç—É–∞–ª—å–Ω—ñ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó (`README.md`, `STARTUP_GUIDE.md`):

### –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –≤ –±–æ—Ç—ñ
- –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π —Ñ–ª–æ—É —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª—ñ–¥–∞ –ø—ñ—Å–ª—è AI-—Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è:
  - `‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏`
  - `‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏`
  - `‚ùì –ó–º—ñ–Ω–∏—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è`
- –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π —Ñ–ª–æ—É –ø—ñ—Å–ª—è AI-–∞–Ω–∞–ª—ñ–∑—É –ª—ñ–¥–∞:
  - `üìû Contacted`
  - `‚úÖ Qualify`
  - `üöÄ Transfer`
  - `üìù –î–æ–¥–∞—Ç–∏ –Ω–æ—Ç–∞—Ç–∫—É`
  - `‚û°Ô∏è –ù–∞—Å—Ç—É–ø–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è`
  - `üìÑ –ö–∞—Ä—Ç–∫–∞ –ª—ñ–¥–∞`
- –õ–æ–≥—ñ–∫–∞ —É—Ç–æ—á–Ω–µ–Ω–Ω—è –Ω–∞–º—ñ—Ä—É (safe-guard): –ø—Ä–∏ –Ω–∏–∑—å–∫—ñ–π –≤–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ NLU –±–æ—Ç –ø—Ä–æ—Å–∏—Ç—å –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª—é–≤–∞—Ç–∏ –∑–∞–ø–∏—Ç.
- Slot-filling –ª–æ–≥—ñ–∫–∞ –¥–ª—è –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö:
  - create: –º—ñ–Ω—ñ–º—É–º name/phone/email
  - analyze: –æ–±–æ–≤'—è–∑–∫–æ–≤–æ `lead_id`
  - note: `lead_id` + `content`

### –©–æ —Ü–µ –¥–∞—î –±—ñ–∑–Ω–µ—Å—É
- –ú–µ–Ω—à–µ –ø–æ–º–∏–ª–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —É —Å–ø—ñ–ª—å–Ω—É –±–∞–∑—É CRM.
- –ö–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∏–π human-in-the-loop –ø–µ—Ä–µ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º/–∑–º—ñ–Ω–æ—é –¥–∞–Ω–∏—Ö.
- –®–≤–∏–¥–∫–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö –∫—Ä–æ–∫—ñ–≤ –ø–æ –ª—ñ–¥–æ–≤—ñ –ø—Ä—è–º–æ –∑ –∫–Ω–æ–ø–æ–∫.

---

## –ó–º—ñ—Å—Ç

1. [–í–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ –≤ –ø–æ—Ç–æ—á–Ω–æ–º—É –∫–æ–¥—ñ](#1-–≤–∏—è–≤–ª–µ–Ω—ñ-–ø—Ä–æ–±–ª–µ–º–∏-–≤-–ø–æ—Ç–æ—á–Ω–æ–º—É-–∫–æ–¥—ñ)
2. [–ö—Ä–∏—Ç–∏—á–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è](#2-–∫—Ä–∏—Ç–∏—á–Ω—ñ-–≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è)
3. [–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏](#3-–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è-–±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏)
4. [–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è AI-—à–∞—Ä—É](#4-–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è-ai-—à–∞—Ä—É)
5. [–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è API —Ç–∞ DX](#5-–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è-api-—Ç–∞-dx)
6. [–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö —Ç–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤](#6-–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è-–±–∞–∑–∏-–¥–∞–Ω–∏—Ö-—Ç–∞-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤)
7. [–ë–µ–∑–ø–µ–∫–∞ —Ç–∞ RBAC](#7-–±–µ–∑–ø–µ–∫–∞-—Ç–∞-rbac)
8. [–°–ø–æ—Å—Ç–µ—Ä–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å —Ç–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è](#8-—Å–ø–æ—Å—Ç–µ—Ä–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å-—Ç–∞-–ª–æ–≥—É–≤–∞–Ω–Ω—è)
9. [–Ü–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞ DevOps](#9-—ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ç–∞-devops)
10. [–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è](#10-—Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è)
11. [Telegram Bot ‚Äî –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è UX](#11-telegram-bot--–ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è-ux)
12. [Dashboard ‚Äî React](#12-dashboard--react)
13. [Production-roadmap](#13-production-roadmap)

---

## 1. –í–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏ –≤ –ø–æ—Ç–æ—á–Ω–æ–º—É –∫–æ–¥—ñ

### 1.1 –†–æ–∑–±—ñ–∂–Ω—ñ—Å—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç –º—ñ–∂ –º–æ–¥—É–ª—è–º–∏

**–§–∞–π–ª**: `app/ai/prompts.py` (—Ä—è–¥–æ–∫ 50‚Äì51 —Ç–∞ 55)

```python
# –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω ‚Äî –ù–ï–í–Ü–†–ù–û:
VALID_LEAD_SOURCES = frozenset({'WEB', 'REFERRAL', 'SOCIAL', 'MANUAL'})
VALID_LEAD_STAGES = frozenset({'NEW', 'CONTACTED', 'QUALIFIED', 'NEGOTIATION', 'CLOSED'})
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –£ `app/models/lead.py` –≤–∏–∑–Ω–∞—á–µ–Ω—ñ `LeadSource.SCANNER`, `LeadSource.PARTNER`, `LeadSource.REGISTRATION` —Ç–æ—â–æ, –∞ –≤ `prompts.py` —Ü—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—ñ–¥—Å—É—Ç–Ω—ñ —è–∫ –≤–∞–ª—ñ–¥–Ω—ñ. –Ø–∫—â–æ –ª—ñ–¥ –∑—ñ –¥–∂–µ—Ä–µ–ª–æ–º `SCANNER` –ø–æ—Ç—Ä–∞–ø–ª—è—î –Ω–∞ AI-–∞–Ω–∞–ª—ñ–∑, –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –≤–ø–∞–¥–µ –∑ `ValueError`. –ê–Ω–∞–ª–æ–≥—ñ—á–Ω–æ, `VALID_LEAD_STAGES` –º—ñ—Å—Ç–∏—Ç—å `NEGOTIATION/CLOSED` –∑–∞–º—ñ—Å—Ç—å —Ä–µ–∞–ª—å–Ω–∏—Ö `CONTACTED/QUALIFIED/TRANSFERRED/LOST`.

**–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**:
```python
# –ü–æ—Ç—Ä—ñ–±–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∑ models/lead.py:
VALID_LEAD_SOURCES = frozenset({
    'WEB', 'REFERRAL', 'SOCIAL', 'MANUAL', 'SCANNER', 'PARTNER',
    'REGISTRATION', 'CALLBACK', 'LEAD_MAGNET', 'MESSAGE'
})
VALID_LEAD_STAGES = frozenset({'NEW', 'CONTACTED', 'QUALIFIED', 'TRANSFERRED', 'LOST'})
```

---

### 1.2 –î—É–±–ª—é–≤–∞–Ω–Ω—è —ñ–º–ø–æ—Ä—Ç—É –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ

**–§–∞–π–ª**: `app/api/v1/leads.py` (—Ä—è–¥–æ–∫ 12 —ñ 27)

```python
from app.core.deps import get_lead_service, get_transfer_service  # —Ä—è–¥–æ–∫ 12
# ...
from app.core.deps import get_lead_service, get_transfer_service, get_history_repo  # —Ä—è–¥–æ–∫ 27
```

–û–¥–∏–Ω —ñ —Ç–æ–π —Å–∞–º–∏–π —Å–∏–º–≤–æ–ª —ñ–º–ø–æ—Ä—Ç—É—î—Ç—å—Å—è –¥–≤—ñ—á—ñ. –ü–µ—Ä—à–∏–π —ñ–º–ø–æ—Ä—Ç —î –∑–∞–π–≤–∏–º —ñ –º–æ–∂–µ –≤–≤–æ–¥–∏—Ç–∏ –≤ –æ–º–∞–Ω—É.

---

### 1.3 –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –∑–∞–ø–∏—Å —Ñ–∞–π–ª—É –≤ async-–µ–Ω–¥–ø–æ—ó–Ω—Ç—ñ

**–§–∞–π–ª**: `app/api/v1/leads.py` (—Ä—è–¥–æ–∫ 498‚Äì499)

```python
# –ü–æ—Ç–æ—á–Ω–∏–π ‚Äî –ë–õ–û–ö–£–Ñ event loop:
with open(file_path, "wb") as buffer:
    shutil.copyfileobj(file.file, buffer)
```

**–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è** ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `aiofiles`:
```python
import aiofiles
async with aiofiles.open(file_path, "wb") as buffer:
    content = await file.read()
    await buffer.write(content)
```

---

### 1.4 –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π imort `LeadHistory` –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –º–µ—Ç–æ–¥—É

**–§–∞–π–ª**: `app/services/lead_service.py` (—Ä—è–¥–∫–∏ 118, 209)

```python
# –í —Å–µ—Ä–µ–¥–∏–Ω—ñ –º–µ—Ç–æ–¥—ñ–≤:
from app.models.history import LeadHistory
```

–¢–∞–∫—ñ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ —ñ–º–ø–æ—Ä—Ç–∏ ‚Äî –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω. –í–æ–Ω–∏ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –≤–∏–∫–ª–∏–∫—É –º–µ—Ç–æ–¥—É. `LeadHistory` —Å–ª—ñ–¥ —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –Ω–∞ —Ä—ñ–≤–Ω—ñ –º–æ–¥—É–ª—è.

---

### 1.5 Notes pagination ‚Äî –Ω–µ–µ—Ñ–µ–∫—Ç–∏–≤–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –Ω–æ—Ç–∞—Ç–æ–∫

**–§–∞–π–ª**: `app/api/v1/leads.py` (—Ä—è–¥–æ–∫ 279‚Äì286)

```python
notes = lead.notes          # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –í–°–Ü –Ω–æ—Ç–∞—Ç–∫–∏ –≤ –ø–∞–º'—è—Ç—å
total = len(notes)
start = (page - 1) * page_size
page_notes = notes[start:end]  # –ü–æ—Ç—ñ–º —Ä–æ–±–∏—Ç—å Python-slice
```

–ü—Ä–∏ 10 000 –Ω–æ—Ç–∞—Ç–æ–∫ ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—Å–µ –≤ RAM. –ü–æ—Ç—Ä—ñ–±–µ–Ω SQL-—Ä—ñ–≤–µ–Ω—å –ø–∞–≥—ñ–Ω–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ `OFFSET/LIMIT`.

---

### 1.6 `datetime.now()` –±–µ–∑ timezone –≤ attachment endpoint

**–§–∞–π–ª**: `app/api/v1/leads.py` (—Ä—è–¥–æ–∫ 495)

```python
safe_name = f"{lead_id}_{int(datetime.now().timestamp())}_{file.filename}"
```

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è naive datetime. –ü–æ—Ç—Ä—ñ–±–Ω–æ `datetime.now(UTC)`.

---

### 1.7 –ù–µ–Ω–∞–¥—ñ–π–Ω–∞ –ª–æ–≥—ñ–∫–∞ `user.current_leads` 

**–§–∞–π–ª**: `app/api/v1/leads.py` (–º–µ—Ç–æ–¥–∏ assign/unassign/reassign)

`current_leads` –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤—Ä—É—á–Ω—É (`+= 1`, `-= 1`). –ü—Ä–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –∑–∞–ø–∏—Ç–∞—Ö –∞–±–æ –ø–æ–º–∏–ª–∫–∞—Ö —Ü–µ –ø—Ä–∏–∑–≤–µ–¥–µ –¥–æ race condition —Ç–∞ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞. –ü–æ—Ç—Ä—ñ–±–Ω–æ –∞–±–æ `SELECT COUNT(*)` —É —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ, –∞–±–æ –æ–ø—Ç–∏–º—ñ—Å—Ç–∏—á–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è.

---

## 2. –ö—Ä–∏—Ç–∏—á–Ω—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### 2.1 –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç AI-–≤–∞–ª—ñ–¥–∞—Ç–æ—Ä–∞ –∑ –º–æ–¥–µ–ª—è–º–∏

- [ ] –û–Ω–æ–≤–∏—Ç–∏ `VALID_LEAD_SOURCES` —É `prompts.py`, —â–æ–± –≤—ñ–¥–æ–±—Ä–∞–∂–∞–≤ —É—Å—ñ `LeadSource` enum-–∑–Ω–∞—á–µ–Ω–Ω—è
- [ ] –û–Ω–æ–≤–∏—Ç–∏ `VALID_LEAD_STAGES` —É `prompts.py` –Ω–∞ `ColdStage` enum-–∑–Ω–∞—á–µ–Ω–Ω—è
- [ ] –î–æ–¥–∞—Ç–∏ unit-—Ç–µ—Å—Ç, —â–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î: –∫–æ–∂–µ–Ω `LeadSource` –ø—Ä–æ—Ö–æ–¥–∏—Ç—å `_validate_lead_features`

### 2.2 Async —Ñ–∞–π–ª–æ–≤–∏–π I/O

- [ ] –î–æ–¥–∞—Ç–∏ `aiofiles` –¥–æ `requirements.txt`
- [ ] –ü–µ—Ä–µ–ø–∏—Å–∞—Ç–∏ upload endpoint –Ω–∞ async I/O
- [ ] –î–æ–¥–∞—Ç–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É —Ñ–∞–π–ª—É (–Ω–∞—Ä–∞–∑—ñ –≤—ñ–¥—Å—É—Ç–Ω—î ‚Äî DoS –≤–µ–∫—Ç–æ—Ä)
- [ ] –î–æ–¥–∞—Ç–∏ whitelist MIME-—Ç–∏–ø—ñ–≤

### 2.3 –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è imports

- [ ] –ü—Ä–∏–±—Ä–∞—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç —ñ–º–ø–æ—Ä—Ç—É –≤ `leads.py`
- [ ] –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å—ñ `from app.models.history import LeadHistory` —É top-level imports —Å–µ—Ä–≤—ñ—Å—ñ–≤

---

## 3. –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏

### 3.1 –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è Stage Machine

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: –õ—ñ–¥ –º–æ–∂–µ –¥–µ–≥—Ä–∞–¥—É–≤–∞—Ç–∏ –≤ `LOST` –∑ –±—É–¥—å-—è–∫–æ–≥–æ –µ—Ç–∞–ø—É, –∞–ª–µ –Ω–µ –º–æ–∂–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –Ω–∞–∑–∞–¥ –∑ –Ω–µ—Ç–µ—Ä–º—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –µ—Ç–∞–ø—É.

**–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è**: –í–≤–µ—Å—Ç–∏ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—é `stage_back` –¥–ª—è `CONTACTED ‚Üí NEW` —É —Ä–∞–∑—ñ –≤—Ç—Ä–∞—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç—É (–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –Ω–∞ cold outreach). –¶–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ä–µ–∞–ª—å–Ω—ñ–π CRM-–ø—Ä–∞–∫—Ç–∏—Ü—ñ.

```python
# –ù–æ–≤–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞:
REVERSIBLE_STAGE_TRANSITIONS = {
    ColdStage.CONTACTED: ColdStage.NEW,     # Lost contact
    ColdStage.QUALIFIED: ColdStage.CONTACTED,  # Lost qualification
}
```

–ú–µ—Ç–æ–¥ –≤ `LeadService`:
```python
async def rollback_stage(self, lead: Lead, reason: str) -> Lead:
    """–î–æ–∑–≤–æ–ª—è—î –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –Ω–∞ –æ–¥–∏–Ω –∫—Ä–æ–∫ –Ω–∞–∑–∞–¥ –∑ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–º reason."""
```

---

### 3.2 Lead Scoring ‚Äî –ø–æ–ª–µ `quality_tier`

–î–æ–¥–∞—Ç–∏ –¥–µ–Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–µ –ø–æ–ª–µ `quality_tier: Mapped[str | None]`, —â–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ AI score:
- `HOT` (score ‚â• 0.8)
- `WARM` (score 0.6‚Äì0.8)
- `COLD` (score 0.3‚Äì0.6)
- `DEAD` (score < 0.3)

–¶–µ –¥–∞—î –∑–º–æ–≥—É —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –±–µ–∑ float-–ø–æ—Ä—ñ–≤–Ω—è–Ω—å —É DB —ñ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ —Ç–µ–ø–ª–æ–≤—É –∫–∞—Ä—Ç—É –≤ –¥–∞—à–±–æ—Ä–¥—ñ.

---

### 3.3 Lead Aging ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è

–ù–æ–≤–∞ –ø–æ–ª–µ `last_activity_at: Mapped[datetime]` (–æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É `increment_messages` –∞–±–æ `transition_stage`). Celery –∑–∞–¥–∞—á–∞ `check_stale_leads` –ø–æ–≤–∏–Ω–Ω–∞:

1. –®—É–∫–∞—Ç–∏ –ª—ñ–¥–∏, –¥–µ `last_activity_at < NOW() - N days` —ñ stage ‚àà `{CONTACTED, QUALIFIED}`
2. –í—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è assigned_to –º–µ–Ω–µ–¥–∂–µ—Ä—É
3. –õ–æ–≥—É–≤–∞—Ç–∏ `NURTURE` –∑–∞–ø–∏—Å —É history (–≤–∂–µ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ `nurture_lead`, –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ –¥–æ Celery)

---

### 3.4 Transfer ‚Äî –≤–∞–ª—ñ–¥–∞—Ü—ñ—è —Å—Ç–∞–Ω—É –ª—ñ–¥–∞

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: Transfer –ø–µ—Ä–µ–≤—ñ—Ä—è—î `ai_score >= 0.6` —ñ `business_domain IS NOT NULL`.

**–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è** ‚Äî –¥–æ–¥–∞—Ç–∏ —Ç—Ä–µ—Ç—é —É–º–æ–≤—É: –ª—ñ–¥ –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –Ω–∞ —Å—Ç–∞–¥—ñ—ó `QUALIFIED`. –¢—Ä–∞–Ω—Å—Ñ–µ—Ä –∑ `CONTACTED` –Ω–µ –º–∞—î —Å–µ–Ω—Å—É –≤ —Ä–µ–∞–ª—å–Ω—ñ–π CRM-–ø—Ä–∞–∫—Ç–∏—Ü—ñ.

```python
# –£ TransferService:
if lead.stage not in (ColdStage.QUALIFIED,):
    raise TransferError(
        f"Lead must be in QUALIFIED stage before transfer. Current: {lead.stage.value}"
    )
```

---

### 3.5 –î—É–±–ª—ñ–∫–∞—Ç-–∫–æ–Ω—Ç—Ä–æ–ª—å –ª—ñ–¥—ñ–≤

–î–æ–¥–∞—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –ª—ñ–¥–∞ –∑–∞ `email` —Ç–∞ `phone`. –Ø–∫—â–æ –≤–∂–µ —ñ—Å–Ω—É—î, –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ `409 Conflict` –∑ –ª—ñ–Ω–∫–æ–º –Ω–∞ —ñ—Å–Ω—É—é—á–∏–π –ª—ñ–¥.

```python
class DuplicateLeadError(Exception):
    def __init__(self, existing_id: int):
        self.existing_id = existing_id
```

---

### 3.6 Lead Score History

–ó–∞—Ä–∞–∑ AI score –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î—Ç—å—Å—è –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –∞–Ω–∞–ª—ñ–∑—ñ –±–µ–∑ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è. –í–≤–µ—Å—Ç–∏ –æ–∫—Ä–µ–º—É —Ç–∞–±–ª–∏—Ü—é `lead_score_history`:

```sql
CREATE TABLE lead_score_history (
    id          SERIAL PRIMARY KEY,
    lead_id     INT NOT NULL REFERENCES leads(id),
    score       FLOAT NOT NULL,
    recommendation VARCHAR(64),
    reason      TEXT,
    analyzed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

–¶–µ –¥–∞—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –±—É–¥—É–≤–∞—Ç–∏ —Ç—Ä–µ–Ω–¥–æ–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫ score –Ω–∞–¥ —á–∞—Å–æ–º.

---

### 3.7 Sales Pipeline ‚Äî –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –±—ñ–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: Sale –º–æ–∂–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–∏ –≤ `LOST` –∑ –±—É–¥—å-—è–∫–æ–≥–æ –Ω–µ—Ç–µ—Ä–º—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞–Ω—É.

**–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è**:
- `amount` —î –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–º –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º —É —Å—Ç–∞–Ω `AGREEMENT`
- –ü—Ä–∏ `PAID` ‚Äî –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ `closed_at` timestamp —ñ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏ `duration_days`
- –ü—Ä–∏ `LOST` ‚Äî –≤–∏–º–∞–≥–∞—Ç–∏ `lost_reason: str` (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)

```python
# –ù–æ–≤—ñ –ø–æ–ª—è –≤ Sale model:
lost_reason: Mapped[str | None] = mapped_column(String(512), nullable=True)
closed_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)
duration_days: Mapped[int | None] = mapped_column(Integer, nullable=True)
```

---

## 4. –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è AI-—à–∞—Ä—É

### 4.1 Structured Output –∑–∞–º—ñ—Å—Ç—å prompt engineering

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: AI –ø—Ä–æ–º–ø—Ç –≤–∏–º–∞–≥–∞—î –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ JSON —Ñ–æ—Ä–º–∞—Ç—É —á–µ—Ä–µ–∑ —Ç–µ–∫—Å—Ç. –Ø–∫—â–æ GPT –≤—ñ–¥—Ö–∏–ª—è—î—Ç—å—Å—è, –ø–∞—Ä—Å–∏–Ω–≥ –ª–∞–º–∞—î—Ç—å—Å—è.

**–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è** ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ OpenAI Structured Outputs (JSON Schema mode):

```python
response = await client.chat.completions.create(
    model="gpt-4o-mini",
    response_format={
        "type": "json_schema",
        "json_schema": {
            "name": "lead_analysis",
            "schema": {
                "type": "object",
                "properties": {
                    "score": {"type": "number", "minimum": 0, "maximum": 1},
                    "recommendation": {"type": "string", "enum": ["transfer_to_sales", "continue_nurturing", "lost"]},
                    "reason": {"type": "string"}
                },
                "required": ["score", "recommendation", "reason"],
                "additionalProperties": False
            },
            "strict": True
        }
    },
    messages=[...]
)
```

–¶–µ –≥–∞—Ä–∞–Ω—Ç—É—î –≤–∞–ª—ñ–¥–Ω–∏–π JSON –±–µ–∑ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ try/except –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥.

---

### 4.2 AI Score Confidence Interval

–ó–∞–º—ñ—Å—Ç—å –æ–¥–Ω–æ–≥–æ —Å–∫–∞–ª—è—Ä–Ω–æ–≥–æ `score`, –ø—Ä–æ—Å–∏—Ç–∏ AI –Ω–∞–¥–∞–≤–∞—Ç–∏:
- `score_mean: float` ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞ –æ—Ü—ñ–Ω–∫–∞
- `score_confidence: float` ‚Äî —Ä—ñ–≤–µ–Ω—å –≤–ø–µ–≤–Ω–µ–Ω–æ—Å—Ç—ñ (0.0‚Äì1.0)

–í—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ –≤ UI: `0.72 ¬± 0.08` –∑–∞–º—ñ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ `0.72`.

---

### 4.3 Fallback AI –±–µ–∑ OpenAI (Rule-Based Scoring)

–ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ OpenAI API –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ rule-based fallback:

```python
def rule_based_score(lead: Lead) -> AIAnalysisResult:
    score = 0.0
    reasons = []

    # Source weight
    source_weights = {
        LeadSource.REFERRAL: 0.35, LeadSource.PARTNER: 0.30,
        LeadSource.WEB: 0.25, LeadSource.SCANNER: 0.20,
        LeadSource.SOCIAL: 0.15, LeadSource.MANUAL: 0.10,
    }
    score += source_weights.get(lead.source, 0.10)

    # Activity weight
    if lead.message_count >= 10:
        score += 0.25
        reasons.append("high activity")
    elif lead.message_count >= 5:
        score += 0.15
    elif lead.message_count >= 2:
        score += 0.08

    # Domain weight
    if lead.business_domain:
        score += 0.25
        reasons.append("domain defined")

    # Stage weight
    stage_weights = {
        ColdStage.QUALIFIED: 0.20, ColdStage.CONTACTED: 0.10, ColdStage.NEW: 0.0
    }
    score += stage_weights.get(lead.stage, 0.0)

    score = min(score, 1.0)
    recommendation = (
        "transfer_to_sales" if score >= 0.6
        else "continue_nurturing" if score >= 0.3
        else "lost"
    )
    return AIAnalysisResult(
        score=score,
        recommendation=recommendation,
        reason=f"Rule-based: {', '.join(reasons) or 'low signals'}. [AI OFFLINE]"
    )
```

---

### 4.4 AI Input Feature Engineering

–†–æ–∑—à–∏—Ä–∏—Ç–∏ —Ñ—ñ—á—ñ, —â–æ –ø–æ–¥–∞—é—Ç—å—Å—è –≤ AI, –±–µ–∑ –ø–æ—Ä—É—à–µ–Ω–Ω—è privacy:

| –¢–µ–∫—É—á–∞ —Ñ—ñ—á–∞ | –ù–æ–≤–∞ —Ñ—ñ—á–∞ | –ß–æ–º—É |
|---|---|---|
| `message_count` | `message_velocity` (count / days) | –®–≤–∏–¥–∫—ñ—Å—Ç—å —Ä–æ—Å—Ç—É –≤–∞–∂–ª–∏–≤—ñ—à–∞ –∑–∞ –∞–±—Å–æ–ª—é—Ç–Ω–µ —á–∏—Å–ª–æ |
| - | `has_phone AND has_email` | –ü–æ–≤–Ω–æ—Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∏—Ö –¥–∞–Ω–∏—Ö |
| - | `has_company AND has_position` | B2B qualification signal |
| - | `notes_count` | –ó–∞–ª—É—á–µ–Ω—ñ—Å—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ |
| `days_since_created` | `days_since_last_activity` | –ê–∫—Ç—É–∞–ª—å–Ω—ñ—à–∞ —Å–≤—ñ–∂—ñ—Å—Ç—å |

---

### 4.5 AI Rate Limiting —Ç–∞ Cost Control

–î–æ–¥–∞—Ç–∏ –∂–æ—Ä—Å—Ç–∫–∏–π –ª—ñ–º—ñ—Ç –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å AI-–∑–∞–ø–∏—Ç—ñ–≤:

```python
# Redis-based token bucket:
async def check_ai_rate_limit(lead_id: int) -> bool:
    key = f"ai:rate:{datetime.now(UTC).strftime('%Y-%m-%d')}"
    count = await redis.incr(key)
    await redis.expire(key, 86400)
    return count <= settings.AI_DAILY_LIMIT  # Default: 500
```

---

### 4.6 AI Audit Log

–ö–æ–∂–µ–Ω –≤–∏–∫–ª–∏–∫ AI —Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ —É —Ç–∞–±–ª–∏—Ü—ñ `ai_audit_log`:

```sql
CREATE TABLE ai_audit_log (
    id          SERIAL PRIMARY KEY,
    lead_id     INT REFERENCES leads(id),
    model       VARCHAR(64),
    input_hash  CHAR(64),          -- SHA-256 input –¥–ª—è –¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—ó
    score       FLOAT,
    recommendation VARCHAR(64),
    latency_ms  INT,
    tokens_used INT,
    cost_usd    FLOAT,
    created_at  TIMESTAMPTZ DEFAULT NOW()
);
```

–¶–µ–π –ª–æ–≥ –¥–∞—î –∑–º–æ–≥—É:
- –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ cost per lead
- –í–∏—è–≤–ª—è—Ç–∏ –∞–Ω–æ–º–∞–ª—ñ—ó –≤ AI response
- –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ RLHF feedback loop

---

## 5. –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è API —Ç–∞ DX

### 5.1 –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–º–∏–ª–æ–∫

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: –ü–æ–º–∏–ª–∫–∏ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å—Å—è —è–∫ –≥–æ–ª–∏–π —Ä—è–¥–æ–∫ —É `detail`.

**–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è** ‚Äî RFC 7807 (Problem Details):

```json
{
  "type": "https://crm.example.com/errors/lead-stage-invalid",
  "title": "Invalid Stage Transition",
  "status": 400,
  "detail": "Cannot transition from 'NEW' to 'QUALIFIED'. Expected: 'CONTACTED'.",
  "instance": "/api/v1/leads/42/stage",
  "lead_id": 42,
  "current_stage": "NEW",
  "requested_stage": "QUALIFIED"
}
```

–¶–µ –¥–æ–∑–≤–æ–ª—è—î –∫–ª—ñ—î–Ω—Ç–∞–º (–±–æ—Ç, –¥–∞—à–±–æ—Ä–¥) —Ä–µ–∞–≥—É–≤–∞—Ç–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ —Ç–∏–ø–∏ –ø–æ–º–∏–ª–æ–∫ –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥—É —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö —Ä—è–¥–∫—ñ–≤.

---

### 5.2 API Versioning Strategy

–ü–æ—Ç–æ—á–Ω–∞ –≤–µ—Ä—Å—ñ—è `v1` —ñ—Å–Ω—É—î –æ–¥–∏–Ω –≤–∏–¥. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:
- –ó–∞–º–æ—Ä–æ–∑–∏—Ç–∏ `v1` interface (breaking changes ‚Üí `v2`)
- –î–æ–¥–∞—Ç–∏ `Deprecation` –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏—Ö –µ–Ω–¥–ø–æ—ó–Ω—Ç—ñ–≤
- –í–µ—Ä—Å—ñ–æ–Ω—É–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ URL (`/api/v2/`) –∞ –Ω–µ —á–µ—Ä–µ–∑ header (–ø—Ä–æ—Å—Ç—ñ—à–µ –¥–ª—è debug)

---

### 5.3 Cursor-based Pagination

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: Offset-based pagination (`page`, `page_size`).

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—Ä–∏ 100 000 –ª—ñ–¥—ñ–≤ `OFFSET 99000 LIMIT 50` ‚Äî –ø–æ–≤–Ω–∏–π scan —Ç–∞–±–ª–∏—Ü—ñ.

**–†—ñ—à–µ–Ω–Ω—è** ‚Äî Cursor-based:
```
GET /api/v1/leads?cursor=eyJpZCI6IDEwMH0&limit=50
Response: { "items": [...], "next_cursor": "eyJpZCI6IDE1MH0" }
```

–†–µ–∞–ª—ñ–∑—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `WHERE id > :last_id ORDER BY id LIMIT :limit`.

---

### 5.4 Bulk Operations API

–î–æ–¥–∞—Ç–∏ endpoint –¥–ª—è –ø–∞–∫–µ—Ç–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π:

```
POST /api/v1/leads/bulk/stage      ‚Äî –º–∞—Å–æ–≤–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ —Å—Ç–∞–¥—ñ—ó
POST /api/v1/leads/bulk/assign     ‚Äî –º–∞—Å–æ–≤–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
POST /api/v1/leads/bulk/analyze    ‚Äî –∑–∞–ø—É—Å–∫ AI –∞–Ω–∞–ª—ñ–∑—É –¥–ª—è –º–∞—Å–∏–≤—É –ª—ñ–¥—ñ–≤
DELETE /api/v1/leads/bulk          ‚Äî –º–∞—Å–æ–≤–µ –≤–∏–¥–∞–ª–µ–Ω–Ω—è (Admin only)
```

---

### 5.5 Search/Filter —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è

–ü–æ—Ç–æ—á–Ω–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø—ñ–¥—Ç—Ä–∏–º—É—î –ª–∏—à–µ —Ç–æ—á–Ω–∏–π –∑–±—ñ–≥. –î–æ–¥–∞—Ç–∏:

```
GET /api/v1/leads?q=Nikolas              # Full-text search –ø–æ name, email, company
GET /api/v1/leads?ai_score_min=0.6       # –ü–æ—à—É–∫ –∑–∞ AI score range
GET /api/v1/leads?ai_score_max=0.9
GET /api/v1/leads?created_after=2026-01-01
GET /api/v1/leads?stage=NEW,CONTACTED    # Multi-value filter
GET /api/v1/leads?sort=ai_score:desc     # –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
```

---

### 5.6 ETag —Ç–∞ Conditional Requests

–î–ª—è –∑–º–µ–Ω—à–µ–Ω–Ω—è –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ API –¥–æ–¥–∞—Ç–∏ `ETag`:

```
GET /api/v1/leads/42
Response: ETag: "abc123", Cache-Control: max-age=30

GET /api/v1/leads/42
If-None-Match: "abc123"
Response: 304 Not Modified  ‚Üê –±–µ–∑ body
```

---

## 6. –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö —Ç–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤

### 6.1 Missing Database Indexes

–ê–Ω–∞–ª—ñ–∑ –ø–æ—Ç–æ—á–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ –ø–æ–∫–∞–∑—É—î –≤—ñ–¥—Å—É—Ç–Ω—ñ —ñ–Ω–¥–µ–∫—Å–∏:

```sql
-- –ù–µ–æ–±—Ö—ñ–¥–Ω—ñ –Ω–æ–≤—ñ —ñ–Ω–¥–µ–∫—Å–∏:
CREATE INDEX idx_leads_ai_score ON leads(ai_score) WHERE ai_score IS NOT NULL;
CREATE INDEX idx_leads_stage_created ON leads(stage, created_at DESC);
CREATE INDEX idx_leads_assigned_stage ON leads(assigned_to_id, stage);
CREATE INDEX idx_leads_source_domain ON leads(source, business_domain);
CREATE INDEX idx_sales_stage_lead ON sales(stage, lead_id);
CREATE INDEX idx_history_lead_created ON lead_history(lead_id, created_at DESC);
CREATE INDEX idx_notes_lead_created ON lead_notes(lead_id, created_at DESC);
```

---

### 6.2 Soft Delete –∑–∞–º—ñ—Å—Ç—å Hard Delete

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: `DELETE /api/v1/leads/{id}` –≤–∏–∫–æ–Ω—É—î `DELETE FROM leads`.

**–ü—Ä–æ–±–ª–µ–º–∞**: –í—Ç—Ä–∞—Ç–∞ –≤—Å—ñ—î—ó audit trail, history, notes, attachments.

**–†—ñ—à–µ–Ω–Ω—è** ‚Äî Soft delete:
```python
# –î–æ–¥–∞—Ç–∏ –¥–æ Lead model:
is_deleted: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False)
deleted_at: Mapped[datetime | None] = mapped_column(DateTime(timezone=True), nullable=True)
deleted_by: Mapped[str | None] = mapped_column(String(128), nullable=True)
```

–í—Å—ñ GET-–∑–∞–ø–∏—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ñ—ñ–ª—å—Ç—Ä—É—é—Ç—å `WHERE is_deleted = FALSE` —á–µ—Ä–µ–∑ Session Event –∞–±–æ Repository base.

---

### 6.3 Repository Pattern ‚Äî Base Class

–ü–æ—Ç–æ—á–Ω—ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó, –æ—á–µ–≤–∏–¥–Ω–æ, –º–∞—é—Ç—å –¥—É–±–ª—é–≤–∞–Ω–Ω—è CRUD-–∫–æ–¥—É. –í–≤–µ—Å—Ç–∏:

```python
class BaseRepository(Generic[T]):
    model: type[T]
    
    async def get_by_id(self, id: int) -> T | None: ...
    async def create(self, entity: T) -> T: ...
    async def save(self, entity: T) -> T: ...
    async def delete(self, entity: T) -> None: ...
    async def count(self, **filters) -> int: ...
```

---

### 6.4 Database Transaction Management

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: Session flush/commit –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —É —Ä—ñ–∑–Ω–∏—Ö –º—ñ—Å—Ü—è—Ö (—Å–µ—Ä–≤—ñ—Å —ñ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π).

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è**: Unit of Work pattern ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –Ω–∞ —Ä—ñ–≤–Ω—ñ HTTP request —ñ –∫–æ–º—ñ—Ç–∏—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ —É—Å–ø—ñ—à–Ω–æ–º—É –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ handler. Rollback –ø—Ä–∏ –±—É–¥—å-—è–∫–æ–º—É exception.

```python
# –í middleware –∞–±–æ dependency:
async def get_db() -> AsyncGenerator[AsyncSession, None]:
    async with async_session() as session:
        async with session.begin():
            yield session
        # AUTO COMMIT or ROLLBACK
```

---

### 6.5 Connection Pooling —Ç–∞ Timeout

–î–æ–¥–∞—Ç–∏ –¥–æ DB –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó:
```python
engine = create_async_engine(
    settings.DATABASE_URL,
    pool_size=20,
    max_overflow=10,
    pool_pre_ping=True,          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–≤'—è–∑–∫—É –ø–µ—Ä–µ–¥ –≤–∏–¥–∞—á–µ—é
    pool_recycle=3600,           # –°–∫–∏–¥–∞—Ç–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è –∫–æ–∂–Ω—É –≥–æ–¥–∏–Ω—É
    connect_args={"command_timeout": 30},  # Query timeout
)
```

---

## 7. –ë–µ–∑–ø–µ–∫–∞ —Ç–∞ RBAC

### 7.1 JWT Authentication –∑–∞–º—ñ—Å—Ç—å Static Token

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: `verify_api_token` –ø–µ—Ä–µ–≤—ñ—Ä—è—î –æ–¥–∏–Ω —Å—Ç–∞—Ç–∏—á–Ω–∏–π `API_SECRET_TOKEN` –∑ `.env`.

**–ü—Ä–æ–±–ª–µ–º–∞**: 
- –û–¥–∏–Ω —Ç–æ–∫–µ–Ω –¥–ª—è –≤—Å—ñ—Ö ‚Äî –Ω–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–∫–ª–∏–∫–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- –ù–µ–º–∞—î –ø—Ä–∏–≤'—è–∑–∫–∏ —Ç–æ–∫–µ–Ω–∞ –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —é–∑–µ—Ä–∞/—Ä–æ–ª—ñ
- –¢–æ–∫–µ–Ω –Ω–µ –º–∞—î TTL

**–†—ñ—à–µ–Ω–Ω—è** ‚Äî JWT:
```
POST /api/v1/auth/login  ‚Üí  { "access_token": "...", "expires_in": 3600 }
POST /api/v1/auth/refresh  ‚Üí  –Ω–æ–≤–∏–π access token
POST /api/v1/auth/logout  ‚Üí  —ñ–Ω–≤–∞–ª—ñ–¥–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Redis blacklist
```

Payload JWT:
```json
{
  "sub": "user_id",
  "role": "manager",
  "exp": 1740000000,
  "jti": "unique-token-id"  // –¥–ª—è blacklist
}
```

---

### 7.2 RBAC Matrix

–ß—ñ—Ç–∫—ñ—à–µ –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º–∞—Ç—Ä–∏—Ü—é –ø—Ä–∞–≤:

| –î—ñ—è | Agent | Manager | Admin |
|-----|-------|---------|-------|
| –ü–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ —Å–≤–æ—ó—Ö –ª—ñ–¥—ñ–≤ | ‚úÖ | ‚úÖ | ‚úÖ |
| –ü–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –≤—Å—ñ—Ö –ª—ñ–¥—ñ–≤ | ‚ùå | ‚úÖ | ‚úÖ |
| –°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –ª—ñ–¥—ñ–≤ | ‚úÖ | ‚úÖ | ‚úÖ |
| –ü—Ä–∏–∑–Ω–∞—á–∞—Ç–∏ –ª—ñ–¥—ñ–≤ | ‚ùå | ‚úÖ | ‚úÖ |
| –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–∏ —Å—Ç–∞–¥—ñ—ó | ‚úÖ | ‚úÖ | ‚úÖ |
| –ó–∞–ø—É—Å–∫–∞—Ç–∏ AI –∞–Ω–∞–ª—ñ–∑ | ‚úÖ | ‚úÖ | ‚úÖ |
| –ü–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ –≤ –ø—Ä–æ–¥–∞–∂—ñ | ‚ùå | ‚úÖ | ‚úÖ |
| –í–∏–¥–∞–ª—è—Ç–∏ –ª—ñ–¥—ñ–≤ | ‚ùå | ‚ùå | ‚úÖ |
| –ü–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –¥–∞—à–±–æ—Ä–¥ | ‚ùå | ‚úÖ | ‚úÖ |
| –£–ø—Ä–∞–≤–ª—è—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏ | ‚ùå | ‚ùå | ‚úÖ |
| –ï–∫—Å–ø–æ—Ä—Ç CSV | ‚ùå | ‚úÖ | ‚úÖ |

---

### 7.3 Input Sanitization

–ü–æ—Ç–æ—á–Ω—ñ –ø–æ–ª—è `intent`, `pain_points`, `notes.content` –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç—å XSS/injection sanitization. –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ–ª—ñ–≤ –¥–æ–¥–∞—Ç–∏:

```python
import bleach

def sanitize_text(value: str, max_length: int = 1024) -> str:
    cleaned = bleach.clean(value, tags=[], strip=True)
    return cleaned[:max_length].strip()
```

---

### 7.4 File Upload Security

```python
ALLOWED_MIME_TYPES = {
    "image/jpeg", "image/png", "image/gif",
    "application/pdf", "text/plain",
    "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
}
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10 MB

async def validate_upload(file: UploadFile) -> None:
    if file.content_type not in ALLOWED_MIME_TYPES:
        raise HTTPException(400, f"File type {file.content_type} is not allowed")
    
    content = await file.read(MAX_FILE_SIZE + 1)
    if len(content) > MAX_FILE_SIZE:
        raise HTTPException(413, "File exceeds 10 MB limit")
    
    # Magic bytes validation (not just MIME header):
    import magic
    detected = magic.from_buffer(content[:2048], mime=True)
    if detected not in ALLOWED_MIME_TYPES:
        raise HTTPException(400, "File content does not match declared type")
```

---

### 7.5 Rate Limiting per User

–ü–æ—Ç–æ—á–Ω–∏–π `rate_limit.py` –æ–±–º–µ–∂—É—î –ø–æ IP. –ü–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ per-user rate limiting –ø—ñ—Å–ª—è JWT integraiton:

```
Lead Creation:      10/hour per user
AI Analysis:        20/day per user
Stage Transitions:  100/hour per user
File Uploads:       5/hour per user
```

---

## 8. –°–ø–æ—Å—Ç–µ—Ä–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å —Ç–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è

### 8.1 Structured Logging (JSON)

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: –õ–æ–≥–∏ —É plain text —Ñ–æ—Ä–º–∞—Ç.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è** ‚Äî `structlog` –∑ JSON —Ñ–æ—Ä–º–∞—Ç–æ–º:

```python
import structlog

log = structlog.get_logger()

log.info(
    "lead_stage_transition",
    lead_id=lead.id,
    old_stage=current.value,
    new_stage=new_stage.value,
    changed_by=changed_by,
    duration_ms=elapsed,
)
```

–í–∏—Ö—ñ–¥:
```json
{"event": "lead_stage_transition", "lead_id": 42, "old_stage": "NEW", "new_stage": "CONTACTED", "changed_by": "manager@example.com", "duration_ms": 12}
```

---

### 8.2 Distributed Tracing

–î–æ–¥–∞—Ç–∏ `opentelemetry-sdk` + Jaeger –¥–ª—è —Ç—Ä–∞—Å—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤ –≤—ñ–¥ API –¥–æ DB –¥–æ AI:

```python
from opentelemetry import trace
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor
from opentelemetry.instrumentation.sqlalchemy import SQLAlchemyInstrumentor

FastAPIInstrumentor.instrument_app(app)
SQLAlchemyInstrumentor().instrument()
```

---

### 8.3 Business Metrics (Prometheus)

–î–æ–¥–∞—Ç–∏ `prometheus-fastapi-instrumentator` + –∫–∞—Å—Ç–æ–º–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏:

```python
from prometheus_client import Counter, Histogram, Gauge

LEADS_CREATED = Counter("crm_leads_created_total", "Total leads created", ["source"])
LEADS_BY_STAGE = Gauge("crm_leads_by_stage", "Leads count per stage", ["stage"])
AI_LATENCY = Histogram("crm_ai_analysis_duration_seconds", "AI analysis latency")
TRANSFER_RATE = Counter("crm_transfers_total", "Lead to sales transfers", ["result"])
```

Dashboard —É Grafana –∑ –∞–ª–µ—Ä—Ç–∞–º–∏: conversion rate < X%, AI error rate > Y%.

---

### 8.4 Health Check ‚Äî —Ä–æ–∑—à–∏—Ä–µ–Ω–∏–π

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: `/health` –ø–æ–≤–µ—Ä—Ç–∞—î `{"status": "ok"}`.

**–†–æ–∑—à–∏—Ä–µ–Ω–Ω—è** ‚Äî –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∏–π health check:

```json
{
  "status": "healthy",
  "components": {
    "database": {"status": "healthy", "latency_ms": 3},
    "redis": {"status": "healthy", "latency_ms": 1},
    "openai": {"status": "healthy", "latency_ms": 342},
    "celery": {"status": "healthy", "active_workers": 2}
  },
  "uptime_seconds": 86400,
  "version": "1.2.0"
}
```

---

## 9. –Ü–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞ DevOps

### 9.1 Environment Configuration

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: –í—Å—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤ –æ–¥–Ω–æ–º—É `.env`.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è** ‚Äî Staged environments:

```
.env.development  ‚Äî SQLite, debug=true, mock AI
.env.staging      ‚Äî PostgreSQL, rate limits lower
.env.production   ‚Äî PostgreSQL, Redis Sentinel, strict security
```

---

### 9.2 Docker ‚Äî Production Hardening

–ü–æ—Ç–æ—á–Ω–∏–π `Dockerfile` (–±–∞–∑–æ–≤–∏–π). Production-ready –≤–∞—Ä—ñ–∞–Ω—Ç:

```dockerfile
FROM python:3.12-slim AS builder
# ... –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π

FROM python:3.12-slim AS runtime
RUN groupadd -r crm && useradd -r -g crm crm  # Non-root user
USER crm

# –û–±–º–µ–∂–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤ —É docker-compose:
deploy:
  resources:
    limits:
      cpus: '0.5'
      memory: 512M
```

---

### 9.3 Alembic Migration Strategy

- [ ] –ó–∞–±–æ—Ä–æ–Ω–∏—Ç–∏ `alembic downgrade` –≤ production CI/CD
- [ ] –î–æ–¥–∞—Ç–∏ pre-migration backup hook
- [ ] –í–≤–µ—Å—Ç–∏ naming convention –¥–ª—è –º—ñ–≥—Ä–∞—Ü—ñ–π: `{YYYYMMDD}_{hhmm}_{description}`
- [ ] –î–æ–¥–∞—Ç–∏ `include_schemas=True` –¥–ª—è multi-schema –ø—ñ–¥—Ç—Ä–∏–º–∫–∏

---

### 9.4 CI/CD Pipeline

```yaml
# .github/workflows/ci.yml
jobs:
  lint:    ruff check . && mypy app/
  test:    pytest tests/ --cov=app --cov-report=xml
  security: bandit -r app/ && safety check
  build:   docker build --target runtime .
  migrate: alembic upgrade head (staging only)
  deploy:  (production manual gate)
```

---

### 9.5 Secrets Management

–ó–∞–º—ñ–Ω–∏—Ç–∏ `.env` —Ñ–∞–π–ª –Ω–∞:
- **Development**: `.env` (OK)
- **Staging/Production**: HashiCorp Vault –∞–±–æ AWS Secrets Manager

```python
# app/core/config.py:
from pydantic_settings import BaseSettings, SecretsSettingsSource

class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        secrets_dir="/run/secrets",  # Docker secrets mount
        env_file=".env",
    )
```

---

## 10. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### 10.1 –¢–µ—Å—Ç–æ–≤–∞ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è (–ø—ñ—Ä–∞–º—ñ–¥–∞)

```
         E2E Tests (5%)
        /               \
    Integration (25%)
   /                     \
Unit Tests (70%)
```

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: `test_business_logic.py`, `verify_logic.py`, `deep_test_crm.py` ‚Äî –∞–ª–µ –≤–æ–Ω–∏, –∑–¥–∞—î—Ç—å—Å—è, –Ω–µ —î pytest-based suite.

---

### 10.2 Unit Tests ‚Äî critical path

```python
# tests/unit/test_lead_service.py
class TestStageTransition:
    @pytest.mark.asyncio
    async def test_sequential_transition_ok(self):
        """NEW ‚Üí CONTACTED should succeed"""
        
    async def test_skip_stage_raises(self):
        """NEW ‚Üí QUALIFIED should raise LeadStageError"""
        
    async def test_terminal_stage_locked(self):
        """TRANSFERRED ‚Üí anything should raise LeadStageError"""
        
    async def test_lost_allowed_from_any_stage(self):
        """Any stage ‚Üí LOST should succeed"""

class TestTransfer:
    async def test_transfer_requires_ai_score(self): ...
    async def test_transfer_requires_domain(self): ...
    async def test_transfer_creates_sale(self): ...
    async def test_transfer_marks_lead_transferred(self): ...

class TestAIValidation:
    def test_all_lead_sources_are_valid_ai_input(self):
        """Every LeadSource enum value must pass _validate_lead_features"""
        for source in LeadSource:
            features = {
                "source": source.value,
                "stage": "NEW",
                "message_count": 0,
                "days_since_created": 1,
            }
            # Should NOT raise:
            _validate_lead_features(features)
```

---

### 10.3 Integration Tests ‚Äî API

```python
# tests/integration/test_leads_api.py
class TestLeadLifecycle:
    async def test_full_pipeline_happy_path(self, client, mock_openai):
        """
        POST /leads ‚Üí PATCH /stage (contacted) ‚Üí PATCH /stage (qualified)
        ‚Üí POST /analyze ‚Üí POST /transfer ‚Üí PATCH /sales/{id}/stage
        """
        
    async def test_parallel_stage_transitions_are_safe(self, client):
        """–î–≤–∞ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –∑–∞–ø–∏—Ç–∏ –Ω–∞ –∑–º—ñ–Ω—É —Å—Ç–∞–¥—ñ—ó ‚Äî –ø–æ–≤–∏–Ω–µ–Ω –ø—Ä–æ–π—Ç–∏ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω"""
```

---

### 10.4 AI Mock Strategy

```python
@pytest.fixture
def mock_openai(mocker):
    return mocker.patch("app.ai.ai_service.openai_client.chat.completions.create",
        return_value=MockResponse(json_content={
            "score": 0.75,
            "recommendation": "transfer_to_sales",
            "reason": "Mock: high quality lead"
        })
    )

@pytest.fixture
def mock_openai_error(mocker):
    mocker.patch(
        "app.ai.ai_service.openai_client.chat.completions.create",
        side_effect=openai.APIConnectionError("Mocked connection error")
    )
```

---

### 10.5 Property-Based Testing

–î–ª—è stage machine ‚Äî `hypothesis`:

```python
from hypothesis import given, strategies as st

@given(
    current=st.sampled_from(list(ColdStage)),
    target=st.sampled_from(list(ColdStage))
)
def test_stage_transition_invariants(current, target):
    """
    Invariant: —è–∫—â–æ current in TERMINAL, transition –∑–∞–≤–∂–¥–∏ raises.
    Invariant: —è–∫—â–æ target == LOST, –∑–∞–≤–∂–¥–∏ –¥–æ–∑–≤–æ–ª–µ–Ω–æ.
    Invariant: —è–∫—â–æ target –Ω–µ next —ñ –Ω–µ LOST, –∑–∞–≤–∂–¥–∏ raises.
    """
```

---

## 11. Telegram Bot ‚Äî –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è UX

### 11.1 Keyboard Navigation Flow

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: –ë–æ—Ç –º–∞—î –±–∞–∑–æ–≤—ñ –∫–æ–º–∞–Ω–¥–∏ `/leads`, `/sales`, `/stats`.

**–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è**:
- –î–æ–¥–∞—Ç–∏ `Back` –∫–Ω–æ–ø–∫—É –Ω–∞ –∫–æ–∂–µ–Ω –µ–∫—Ä–∞–Ω (FSM state stack)
- Breadcrumbs —É –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö: `üè† > üìã Leads > #42 > ü§ñ AI Results`
- –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–¥ –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω—ñ–º–∏ –¥—ñ—è–º–∏: `"–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç–∏ –≤ –ø—Ä–æ–¥–∞–∂—ñ?"` ‚Üí `‚úÖ –¢–∞–∫` / `‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏`

---

### 11.2 –®–≤–∏–¥–∫—ñ –¥—ñ—ó (Quick Actions)

–ü—Ä–∏ –ø–µ—Ä–µ–≥–ª—è–¥—ñ –ª—ñ–¥–∞ ‚Äî Inline –∫–Ω–æ–ø–∫–∏:
```
[ üìû Contacted ] [ ü§ñ AI Analyze ] [ üìù Add Note ]
[ ‚û°Ô∏è Qualified ] [ ‚ùå Mark Lost  ] [ üë§ Reassign ]
```

---

### 11.3 Smart Notifications

Celery + Bot —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è:
- `"‚ö†Ô∏è Lead #42 –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –≤–∂–µ 7 –¥–Ω—ñ–≤"`
- `"üî• AI score –ª—ñ–¥–∞ #15 –≤–∏—Ä—ñ—Å –¥–æ 0.82 ‚Äî —á–∞—Å –ø–µ—Ä–µ–¥–∞—Ç–∏ –≤ –ø—Ä–æ–¥–∞–∂—ñ!"`
- `"üéâ –ü—Ä–æ–¥–∞–∂ #8 –ø–µ—Ä–µ–π—à–æ–≤ —É PAID!"`

---

### 11.4 Telegram Bot ‚Üí Mini App

–î–ª—è –±—ñ–ª—å—à —Å–∫–ª–∞–¥–Ω–æ–≥–æ UI –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Telegram Web App (Mini App):
- –ü–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∞ —Ñ–æ—Ä–º–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª—ñ–¥–∞ –∑ –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
- Drag-and-drop Kanban board –ª—ñ–¥—ñ–≤
- –ì—Ä–∞—Ñ—ñ–∫–∏ AI score trends

---

## 12. Dashboard ‚Äî React

### 12.1 Kanban Board

–ü–µ—Ä–µ—Ç—è–≥—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç–∫–∏ –ª—ñ–¥—ñ–≤ –º—ñ–∂ –∫–æ–ª–æ–Ω–∫–∞–º–∏ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π PATCH stage endpoint.

```
[NEW] ‚Üí [CONTACTED] ‚Üí [QUALIFIED] ‚Üí [TRANSFERRED]
  ‚Üì           ‚Üì            ‚Üì
[LOST]     [LOST]       [LOST]
```

–û–±–º–µ–∂–µ–Ω–Ω—è: WIP (Work in Progress) –ª—ñ–º—ñ—Ç–∏ –Ω–∞ –∫–æ–ª–æ–Ω–∫–∞—Ö.

---

### 12.2 AI Score Heatmap

–¢–∞–±–ª–∏—Ü—è –ª—ñ–¥—ñ–≤ –∑ –∫–æ–ª—å–æ—Ä–æ–≤–∏–º –∫–æ–¥—É–≤–∞–Ω–Ω—è–º –ø–æ AI score:
- üî¥ < 0.3 (Dead)
- üü° 0.3‚Äì0.6 (Cold)
- üü¢ 0.6‚Äì0.8 (Warm)
- üî• > 0.8 (Hot)

---

### 12.3 Conversion Funnel Drill-Down

–ö–ª—ñ–∫ –Ω–∞ –≤–æ—Ä–æ–Ω—Ü—ñ ‚Üí –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –ª—ñ–¥—ñ–≤ –Ω–∞ —Ü—å–æ–º—É –µ—Ç–∞–ø—ñ, –∑ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—î—é —Ç–∞ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è–º.

---

### 12.4 Manager Performance Dashboard

```
  Manager    | Assigned | Converted | Lost | Avg Score | Avg Time-to-Close
  ---------  | -------- | --------- | ---- | --------- | -----------------
  Nikolas    |    23    |    12     |   4  |   0.71    |   8.3 days
  Alex       |    18    |     9     |   6  |   0.64    |   11.2 days
```

---

### 12.5 Real-time Dashboard via WebSocket

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω**: WebSocket —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π (`ws.py`, `manager.broadcast`).

**–ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è**:
- –†–æ–∑–±–∏—Ç–∏ –Ω–∞ —Ç–æ–ø—ñ–∫–∏: `ws://host/ws/dashboard`, `ws://host/ws/leads/{id}`
- –î–æ–¥–∞—Ç–∏ reconnection logic –Ω–∞ —Ñ—Ä–æ–Ω—Ç—ñ (exponential backoff)
- Heartbeat ping/pong –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥

---

## 13. Production-roadmap

### Phase 1 ‚Äî Stability (–¢–∏–∂–¥–µ–Ω—å 1‚Äì2)
–í–∏–ø—Ä–∞–≤–∏—Ç–∏ –≤—Å—ñ –≤–∏—è–≤–ª–µ–Ω—ñ bugs –∑ —Ä–æ–∑–¥—ñ–ª—É 1 —Ç–∞ 2. –ü–æ–∫—Ä–∏—Ç–∏ unit-—Ç–µ—Å—Ç–∞–º–∏ –≤–µ—Å—å critical path.

### Phase 2 ‚Äî Observability (–¢–∏–∂–¥–µ–Ω—å 3)
Structured logging, Prometheus metrics, extended health check.

### Phase 3 ‚Äî Security (–¢–∏–∂–¥–µ–Ω—å 4)
JWT authentication, per-user rate limiting, input sanitization, file security.

### Phase 4 ‚Äî AI Enhancement (–¢–∏–∂–¥–µ–Ω—å 5‚Äì6)
Structured outputs, fallback scoring, AI audit log, cost tracking.

### Phase 5 ‚Äî Scale (–¢–∏–∂–¥–µ–Ω—å 7‚Äì8)
Cursor pagination, bulk APIs, DB indexes, soft delete, connection pooling.

### Phase 6 ‚Äî Product (–¢–∏–∂–¥–µ–Ω—å 9+)
Kanban board, mini app, manager analytics, lead score trends, RLHF feedback loop.

---

## –ü—ñ–¥—Å—É–º–æ–∫

| –ö–∞—Ç–µ–≥–æ—Ä—ñ—è | –ö—ñ–ª—å–∫—ñ—Å—Ç—å –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ | –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç |
|-----------|---------------------|-----------|
| –ö—Ä–∏—Ç–∏—á–Ω—ñ –±–∞–≥–∏ | 7 | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∏–π |
| –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ | 7 —Ä–æ–∑—à–∏—Ä–µ–Ω—å | üü† –í–∏—Å–æ–∫–∏–π |
| AI-—à–∞—Ä | 6 –ø–æ–∫—Ä–∞—â–µ–Ω—å | üü† –í–∏—Å–æ–∫–∏–π |
| API/DX | 6 –ø–æ–∫—Ä–∞—â–µ–Ω—å | üü° –°–µ—Ä–µ–¥–Ω—ñ–π |
| –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö | 5 –ø–æ–∫—Ä–∞—â–µ–Ω—å | üü° –°–µ—Ä–µ–¥–Ω—ñ–π |
| –ë–µ–∑–ø–µ–∫–∞ | 5 –ø–æ–∫—Ä–∞—â–µ–Ω—å | üü† –í–∏—Å–æ–∫–∏–π |
| –°–ø–æ—Å—Ç–µ—Ä–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å | 4 –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è | üü° –°–µ—Ä–µ–¥–Ω—ñ–π |
| –Ü–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | 5 –ø–æ–∫—Ä–∞—â–µ–Ω—å | üü¢ –ù–∏–∑—å–∫–∏–π |
| –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è | 5 –±–ª–æ–∫—ñ–≤ | üü† –í–∏—Å–æ–∫–∏–π |
| Bot UX | 4 –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è | üü¢ –ù–∏–∑—å–∫–∏–π |
| Dashboard | 5 –ø–æ–∫—Ä–∞—â–µ–Ω—å | üü¢ –ù–∏–∑—å–∫–∏–π |

---

*–î–æ–∫—É–º–µ–Ω—Ç –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –∞—É–¥–∏—Ç—É –∫–æ–¥–æ–≤–æ—ó –±–∞–∑–∏ AEL CRM v1.0 ‚Äî 2026-02-22.*
