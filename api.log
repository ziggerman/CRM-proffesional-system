INFO:     Started server process [51067]
INFO:     Waiting for application startup.
Warning: prometheus_fastapi_instrumentator not found, metrics disabled.
2026-02-22 23:53:35,651 [INFO] root: Structlog not found, falling back to standard logging.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
2026-02-22 23:53:36,040 [INFO] httpx: HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 401 Unauthorized"
2026-02-22 23:53:36,041 [WARNING] app.ai.ai_service: AI Model warming failed: Error code: 401 - {'error': {'message': 'Incorrect API key provided: sk-proj-********************************************************************************************************************************************************PFIA. You can find your API key at https://platform.openai.com/account/api-keys.', 'type': 'invalid_request_error', 'code': 'invalid_api_key', 'param': None}, 'status': 401}
2026-02-22 23:53:42,087 [INFO] app.core.middleware: Request started: GET /health
2026-02-22 23:53:42,096 [WARNING] app.api.health: Health check Redis error: Error 61 connecting to localhost:6379. 61.
2026-02-22 23:53:42,096 [INFO] app.core.middleware: Request completed: GET /health - 200
INFO:     127.0.0.1:61535 - "GET /health HTTP/1.1" 200 OK
2026-02-22 23:55:36,417 [INFO] app.core.middleware: Request started: GET /health
2026-02-22 23:55:36,439 [WARNING] app.api.health: Health check Redis error: Error 61 connecting to localhost:6379. 61.
2026-02-22 23:55:36,441 [INFO] app.core.middleware: Request completed: GET /health - 200
INFO:     127.0.0.1:61630 - "GET /health HTTP/1.1" 200 OK
2026-02-22 23:55:52,101 [WARNING] app.api.rate_limit: Redis unavailable, rate limiting disabled: Error 61 connecting to localhost:6379. 61.
2026-02-22 23:55:52,102 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-22 23:55:52,111 [ERROR] sqlalchemy.pool.impl.NullPool: The garbage collector is trying to clean up non-checked-in connection <AdaptedConnection <aiosqlite.core.Connection object at 0x1382571d0>>, which will be dropped, as it cannot be safely terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle.
/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/security.py:62: SAWarning: The garbage collector is trying to clean up non-checked-in connection <AdaptedConnection <aiosqlite.core.Connection object at 0x1382571d0>>, which will be dropped, as it cannot be safely terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle. (This warning originated from the `configure_mappers()` process, which was invoked automatically in response to a user-initiated operation.)
  return User(id=0, username="static_admin", role=UserRole.ADMIN, is_active=True)
2026-02-22 23:55:52,112 [ERROR] sqlalchemy.pool.impl.NullPool: The garbage collector is trying to clean up non-checked-in connection <AdaptedConnection <aiosqlite.core.Connection object at 0x138257390>>, which will be dropped, as it cannot be safely terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle.
/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/security.py:62: SAWarning: The garbage collector is trying to clean up non-checked-in connection <AdaptedConnection <aiosqlite.core.Connection object at 0x138257390>>, which will be dropped, as it cannot be safely terminated.  Please ensure that SQLAlchemy pooled connections are returned to the pool explicitly, either by calling ``close()`` or by using appropriate context managers to manage their lifecycle. (This warning originated from the `configure_mappers()` process, which was invoked automatically in response to a user-initiated operation.)
  return User(id=0, username="static_admin", role=UserRole.ADMIN, is_active=True)
2026-02-22 23:55:52,135 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:61642 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-22 23:55:53,539 [INFO] app.core.middleware: Request started: GET /api/v1/leads/13
2026-02-22 23:55:53,543 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/13 - 200
INFO:     127.0.0.1:61646 - "GET /api/v1/leads/13 HTTP/1.1" 200 OK
2026-02-22 23:55:54,713 [INFO] app.core.middleware: Request started: GET /api/v1/leads/13/notes
2026-02-22 23:55:54,720 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/13/notes - 200
INFO:     127.0.0.1:61649 - "GET /api/v1/leads/13/notes HTTP/1.1" 200 OK
2026-02-22 23:55:56,094 [INFO] app.core.middleware: Request started: GET /api/v1/leads/13
2026-02-22 23:55:56,097 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/13 - 200
INFO:     127.0.0.1:61651 - "GET /api/v1/leads/13 HTTP/1.1" 200 OK
2026-02-22 23:56:02,554 [INFO] app.core.middleware: Request started: GET /api/v1/leads/13
2026-02-22 23:56:02,560 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/13 - 200
INFO:     127.0.0.1:61661 - "GET /api/v1/leads/13 HTTP/1.1" 200 OK
2026-02-22 23:56:12,476 [INFO] app.core.middleware: Request started: GET /api/v1/leads/13
2026-02-22 23:56:12,479 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/13 - 200
INFO:     127.0.0.1:61665 - "GET /api/v1/leads/13 HTTP/1.1" 200 OK
2026-02-22 23:56:14,566 [INFO] app.core.middleware: Request started: GET /api/v1/leads/13
2026-02-22 23:56:14,571 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/13 - 200
INFO:     127.0.0.1:61667 - "GET /api/v1/leads/13 HTTP/1.1" 200 OK
2026-02-22 23:56:17,047 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/13
2026-02-22 23:56:17,056 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/13 - 200
INFO:     127.0.0.1:61670 - "PATCH /api/v1/leads/13 HTTP/1.1" 200 OK
2026-02-22 23:56:17,119 [INFO] app.core.middleware: Request started: GET /api/v1/leads/13
2026-02-22 23:56:17,121 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/13 - 200
INFO:     127.0.0.1:61672 - "GET /api/v1/leads/13 HTTP/1.1" 200 OK
2026-02-22 23:56:18,504 [INFO] app.core.middleware: Request started: GET /api/v1/leads/13
2026-02-22 23:56:18,506 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/13 - 200
INFO:     127.0.0.1:61674 - "GET /api/v1/leads/13 HTTP/1.1" 200 OK
2026-02-22 23:56:22,622 [INFO] app.core.middleware: Request started: GET /api/v1/leads/13
2026-02-22 23:56:22,626 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/13 - 200
INFO:     127.0.0.1:61676 - "GET /api/v1/leads/13 HTTP/1.1" 200 OK
2026-02-22 23:56:26,402 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/13/stage
2026-02-22 23:56:26,409 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/13/stage - 200
INFO:     127.0.0.1:61678 - "PATCH /api/v1/leads/13/stage HTTP/1.1" 200 OK
2026-02-22 23:56:26,469 [INFO] app.core.middleware: Request started: GET /api/v1/leads/13
2026-02-22 23:56:26,472 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/13 - 200
INFO:     127.0.0.1:61680 - "GET /api/v1/leads/13 HTTP/1.1" 200 OK
2026-02-22 23:56:28,569 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/13/stage
2026-02-22 23:56:28,572 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/13/stage - 400
INFO:     127.0.0.1:61682 - "PATCH /api/v1/leads/13/stage HTTP/1.1" 400 Bad Request
2026-02-22 23:56:33,853 [INFO] app.core.middleware: Request started: GET /api/v1/leads/13
2026-02-22 23:56:33,857 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/13 - 200
INFO:     127.0.0.1:61684 - "GET /api/v1/leads/13 HTTP/1.1" 200 OK
2026-02-22 23:58:46,482 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-22 23:58:46,494 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:61707 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-22 23:58:48,575 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-22 23:58:48,580 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:61709 - "GET /api/v1/leads HTTP/1.1" 200 OK
WARNING:  Invalid HTTP request received.
WARNING:  Invalid HTTP request received.
WARNING:  Invalid HTTP request received.
2026-02-23 00:00:16,061 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 00:00:16,071 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:61753 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 00:00:39,433 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 00:00:39,440 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:61762 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 00:01:11,615 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 00:01:11,626 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:61769 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 00:03:06,649 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 00:03:06,659 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:61808 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 00:12:28,501 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 00:12:28,514 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:61943 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 00:12:53,825 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 00:12:53,838 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:61963 - "GET /api/v1/leads?source=partner HTTP/1.1" 200 OK
2026-02-23 00:14:12,080 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 00:14:12,093 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:61984 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 00:14:13,904 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:14:13,908 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:61986 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:14:19,753 [INFO] app.core.middleware: Request started: POST /api/v1/leads/15/analyze
2026-02-23 00:14:19,800 [INFO] app.core.middleware: Request completed: POST /api/v1/leads/15/analyze - 200
INFO:     127.0.0.1:61992 - "POST /api/v1/leads/15/analyze HTTP/1.1" 200 OK
2026-02-23 00:14:22,260 [INFO] app.core.middleware: Request started: POST /api/v1/leads/15/analyze
2026-02-23 00:14:22,270 [INFO] app.core.middleware: Request completed: POST /api/v1/leads/15/analyze - 200
INFO:     127.0.0.1:61994 - "POST /api/v1/leads/15/analyze HTTP/1.1" 200 OK
2026-02-23 00:14:27,829 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:14:27,833 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:61997 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:14:38,848 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:14:38,852 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62000 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:14:40,118 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:14:40,121 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62002 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:14:41,554 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15
2026-02-23 00:14:41,561 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15 - 200
INFO:     127.0.0.1:62004 - "PATCH /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:14:41,625 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:14:41,629 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62006 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:14:42,954 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:14:42,958 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62008 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:14:44,110 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15
2026-02-23 00:14:44,117 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15 - 200
INFO:     127.0.0.1:62010 - "PATCH /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:14:44,188 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:14:44,191 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62012 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:14:54,252 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:14:54,253 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62015 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:14:57,552 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 00:14:57,556 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:62018 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 00:14:59,256 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:14:59,258 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62020 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:15:01,287 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 00:15:01,292 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 200
INFO:     127.0.0.1:62023 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 200 OK
2026-02-23 00:15:01,384 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:15:01,386 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62025 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:15:16,371 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:15:16,376 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62031 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:15:18,983 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 00:15:18,986 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:62033 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 00:15:23,846 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:15:23,851 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62035 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:15:25,638 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 00:15:25,641 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:62037 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 00:15:27,121 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:15:27,124 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62039 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:15:28,948 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 00:15:28,953 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:62041 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 00:15:31,515 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:15:31,519 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62043 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:15:34,226 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 00:15:34,229 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:62045 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 00:15:35,772 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 00:15:35,775 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:62047 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 00:15:37,309 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 00:15:37,312 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:62049 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 00:15:38,952 [INFO] app.core.middleware: Request started: POST /api/v1/leads/15/analyze
2026-02-23 00:15:38,964 [INFO] app.core.middleware: Request completed: POST /api/v1/leads/15/analyze - 200
INFO:     127.0.0.1:62051 - "POST /api/v1/leads/15/analyze HTTP/1.1" 200 OK
2026-02-23 00:15:41,818 [INFO] app.core.middleware: Request started: POST /api/v1/leads/15/analyze
2026-02-23 00:15:41,830 [INFO] app.core.middleware: Request completed: POST /api/v1/leads/15/analyze - 200
INFO:     127.0.0.1:62053 - "POST /api/v1/leads/15/analyze HTTP/1.1" 200 OK
2026-02-23 09:10:53,491 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:10:53,569 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63046 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:11:00,878 [INFO] app.core.middleware: Request started: GET /api/v1/sales
2026-02-23 09:11:00,916 [ERROR] app.core.middleware: Unhandled error: GET /api/v1/sales
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1647, in _object_value_for_elem
    return self._object_lookup[elem]
           ~~~~~~~~~~~~~~~~~~~^^^^^^
KeyError: 'WEB'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/middleware.py", line 77, in dispatch
    )
     
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/contextlib.py", line 222, in __aexit__
    await self.gen.athrow(typ, value, traceback)
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/database.py", line 55, in get_db
    yield session
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 243, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/api/v1/sales.py", line 47, in list_sales
    # CRUD
          
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/repositories/sale_repo.py", line 71, in get_all
    result = await self.db.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 455, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 202, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 244, in chunks
    post_load.invoke(context, path)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 1541, in invoke
    loader(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3197, in _load_for_path
    self._load_via_child(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3228, in _load_via_child
    for k, v in context.session.execute(
                ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 217, in chunks
    fetch = cursor._raw_all_rows()
            ^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in _raw_all_rows
    return [make_row(row) for row in rows]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in <listcomp>
    return [make_row(row) for row in rows]
            ^^^^^^^^^^^^^
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 22, in sqlalchemy.cyextension.resultproxy.BaseRow.__init__
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 79, in sqlalchemy.cyextension.resultproxy._apply_processors
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1767, in process
    value = self._object_value_for_elem(value)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1649, in _object_value_for_elem
    raise LookupError(
LookupError: 'WEB' is not among the defined enum values. Enum name: leadsource. Possible values: SCANNER, PARTNER, MANUAL
2026-02-23 09:11:00,937 [INFO] app.core.middleware: Request completed: GET /api/v1/sales - 500
INFO:     127.0.0.1:63050 - "GET /api/v1/sales HTTP/1.1" 500 Internal Server Error
2026-02-23 09:11:11,740 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:11:11,753 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63053 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:11:22,351 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:11:22,356 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63056 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:11:54,459 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:11:54,472 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63070 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:11:54,480 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:11:54,483 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63072 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:12:13,543 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:12:13,555 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63079 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:12:13,562 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:12:13,567 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63081 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:12:22,690 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:12:22,697 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63084 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:13:11,109 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:13:11,142 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63105 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:13:11,973 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:13:11,978 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:63107 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:13:15,727 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:13:16,097 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63109 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:13:16,624 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:13:16,627 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:63112 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:13:21,467 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:13:21,473 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:63116 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:13:27,118 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:13:27,239 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:63123 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:13:28,776 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 09:13:28,791 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:63127 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:13:30,117 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 09:13:30,126 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:63129 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:13:30,963 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:13:30,966 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:63132 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:13:31,908 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 09:13:31,916 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 200
INFO:     127.0.0.1:63134 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 200 OK
2026-02-23 09:13:32,043 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:13:32,061 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:63136 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:13:32,926 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 09:13:32,929 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:63139 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:13:34,412 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:13:34,414 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:63147 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:13:35,382 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15/notes
2026-02-23 09:13:35,389 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15/notes - 200
INFO:     127.0.0.1:63149 - "GET /api/v1/leads/15/notes HTTP/1.1" 200 OK
2026-02-23 09:13:41,273 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15/notes
2026-02-23 09:13:41,299 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15/notes - 200
INFO:     127.0.0.1:63154 - "GET /api/v1/leads/15/notes HTTP/1.1" 200 OK
2026-02-23 09:13:42,412 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:13:42,414 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:63157 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:13:43,537 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 09:13:43,541 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:63160 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:13:44,733 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 09:13:44,743 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:63167 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:13:47,011 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:13:47,014 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:63169 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:14:08,857 [INFO] app.core.middleware: Request started: GET /api/v1/sales
2026-02-23 09:14:08,869 [ERROR] app.core.middleware: Unhandled error: GET /api/v1/sales
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1647, in _object_value_for_elem
    return self._object_lookup[elem]
           ~~~~~~~~~~~~~~~~~~~^^^^^^
KeyError: 'WEB'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/middleware.py", line 77, in dispatch
    )
     
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/contextlib.py", line 222, in __aexit__
    await self.gen.athrow(typ, value, traceback)
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/database.py", line 55, in get_db
    yield session
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 243, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/api/v1/sales.py", line 47, in list_sales
    # CRUD
          
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/repositories/sale_repo.py", line 71, in get_all
    result = await self.db.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 455, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 202, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 244, in chunks
    post_load.invoke(context, path)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 1541, in invoke
    loader(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3197, in _load_for_path
    self._load_via_child(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3228, in _load_via_child
    for k, v in context.session.execute(
                ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 217, in chunks
    fetch = cursor._raw_all_rows()
            ^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in _raw_all_rows
    return [make_row(row) for row in rows]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in <listcomp>
    return [make_row(row) for row in rows]
            ^^^^^^^^^^^^^
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 22, in sqlalchemy.cyextension.resultproxy.BaseRow.__init__
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 79, in sqlalchemy.cyextension.resultproxy._apply_processors
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1767, in process
    value = self._object_value_for_elem(value)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1649, in _object_value_for_elem
    raise LookupError(
LookupError: 'WEB' is not among the defined enum values. Enum name: leadsource. Possible values: SCANNER, PARTNER, MANUAL
2026-02-23 09:14:08,873 [INFO] app.core.middleware: Request completed: GET /api/v1/sales - 500
INFO:     127.0.0.1:63178 - "GET /api/v1/sales HTTP/1.1" 500 Internal Server Error
2026-02-23 09:15:53,775 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:15:53,796 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63210 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:15:53,805 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:15:53,809 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63212 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:16:03,988 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:16:04,000 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63217 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:16:04,007 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:16:04,012 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63219 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:16:26,505 [INFO] app.core.middleware: Request started: GET /api/v1/sales
2026-02-23 09:16:26,516 [ERROR] app.core.middleware: Unhandled error: GET /api/v1/sales
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1647, in _object_value_for_elem
    return self._object_lookup[elem]
           ~~~~~~~~~~~~~~~~~~~^^^^^^
KeyError: 'WEB'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/middleware.py", line 77, in dispatch
    )
     
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/contextlib.py", line 222, in __aexit__
    await self.gen.athrow(typ, value, traceback)
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/database.py", line 55, in get_db
    yield session
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 243, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/api/v1/sales.py", line 47, in list_sales
    # CRUD
          
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/repositories/sale_repo.py", line 71, in get_all
    result = await self.db.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 455, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 202, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 244, in chunks
    post_load.invoke(context, path)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 1541, in invoke
    loader(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3197, in _load_for_path
    self._load_via_child(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3228, in _load_via_child
    for k, v in context.session.execute(
                ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 217, in chunks
    fetch = cursor._raw_all_rows()
            ^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in _raw_all_rows
    return [make_row(row) for row in rows]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in <listcomp>
    return [make_row(row) for row in rows]
            ^^^^^^^^^^^^^
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 22, in sqlalchemy.cyextension.resultproxy.BaseRow.__init__
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 79, in sqlalchemy.cyextension.resultproxy._apply_processors
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1767, in process
    value = self._object_value_for_elem(value)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1649, in _object_value_for_elem
    raise LookupError(
LookupError: 'WEB' is not among the defined enum values. Enum name: leadsource. Possible values: SCANNER, PARTNER, MANUAL
2026-02-23 09:16:26,518 [INFO] app.core.middleware: Request completed: GET /api/v1/sales - 500
INFO:     127.0.0.1:63230 - "GET /api/v1/sales HTTP/1.1" 500 Internal Server Error
2026-02-23 09:16:29,587 [INFO] app.core.middleware: Request started: GET /api/v1/sales
2026-02-23 09:16:29,593 [INFO] app.core.middleware: Request completed: GET /api/v1/sales - 200
INFO:     127.0.0.1:63234 - "GET /api/v1/sales?stage=AGREEMENT HTTP/1.1" 200 OK
2026-02-23 09:16:32,726 [INFO] app.core.middleware: Request started: GET /api/v1/sales
2026-02-23 09:16:32,732 [ERROR] app.core.middleware: Unhandled error: GET /api/v1/sales
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1647, in _object_value_for_elem
    return self._object_lookup[elem]
           ~~~~~~~~~~~~~~~~~~~^^^^^^
KeyError: 'WEB'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/middleware.py", line 77, in dispatch
    )
     
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/contextlib.py", line 222, in __aexit__
    await self.gen.athrow(typ, value, traceback)
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/database.py", line 55, in get_db
    yield session
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 243, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/api/v1/sales.py", line 47, in list_sales
    # CRUD
          
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/repositories/sale_repo.py", line 71, in get_all
    result = await self.db.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 455, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 202, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 244, in chunks
    post_load.invoke(context, path)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 1541, in invoke
    loader(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3197, in _load_for_path
    self._load_via_child(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3228, in _load_via_child
    for k, v in context.session.execute(
                ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 217, in chunks
    fetch = cursor._raw_all_rows()
            ^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in _raw_all_rows
    return [make_row(row) for row in rows]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in <listcomp>
    return [make_row(row) for row in rows]
            ^^^^^^^^^^^^^
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 22, in sqlalchemy.cyextension.resultproxy.BaseRow.__init__
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 79, in sqlalchemy.cyextension.resultproxy._apply_processors
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1767, in process
    value = self._object_value_for_elem(value)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1649, in _object_value_for_elem
    raise LookupError(
LookupError: 'WEB' is not among the defined enum values. Enum name: leadsource. Possible values: SCANNER, PARTNER, MANUAL
2026-02-23 09:16:32,734 [INFO] app.core.middleware: Request completed: GET /api/v1/sales - 500
INFO:     127.0.0.1:63236 - "GET /api/v1/sales?stage=NEW HTTP/1.1" 500 Internal Server Error
2026-02-23 09:16:35,517 [INFO] app.core.middleware: Request started: GET /api/v1/sales
2026-02-23 09:16:35,558 [ERROR] app.core.middleware: Unhandled error: GET /api/v1/sales
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1647, in _object_value_for_elem
    return self._object_lookup[elem]
           ~~~~~~~~~~~~~~~~~~~^^^^^^
KeyError: 'WEB'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/middleware.py", line 77, in dispatch
    )
     
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/contextlib.py", line 222, in __aexit__
    await self.gen.athrow(typ, value, traceback)
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/database.py", line 55, in get_db
    yield session
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 243, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/api/v1/sales.py", line 47, in list_sales
    # CRUD
          
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/repositories/sale_repo.py", line 71, in get_all
    result = await self.db.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 455, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 202, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 244, in chunks
    post_load.invoke(context, path)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 1541, in invoke
    loader(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3197, in _load_for_path
    self._load_via_child(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3228, in _load_via_child
    for k, v in context.session.execute(
                ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 217, in chunks
    fetch = cursor._raw_all_rows()
            ^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in _raw_all_rows
    return [make_row(row) for row in rows]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in <listcomp>
    return [make_row(row) for row in rows]
            ^^^^^^^^^^^^^
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 22, in sqlalchemy.cyextension.resultproxy.BaseRow.__init__
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 79, in sqlalchemy.cyextension.resultproxy._apply_processors
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1767, in process
    value = self._object_value_for_elem(value)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1649, in _object_value_for_elem
    raise LookupError(
LookupError: 'WEB' is not among the defined enum values. Enum name: leadsource. Possible values: SCANNER, PARTNER, MANUAL
2026-02-23 09:16:35,571 [INFO] app.core.middleware: Request completed: GET /api/v1/sales - 500
INFO:     127.0.0.1:63238 - "GET /api/v1/sales HTTP/1.1" 500 Internal Server Error
2026-02-23 09:16:37,341 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:16:37,366 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63240 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:16:54,899 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:16:54,905 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63243 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:16:56,651 [INFO] app.core.middleware: Request started: GET /api/v1/leads/14
2026-02-23 09:16:56,654 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/14 - 200
INFO:     127.0.0.1:63245 - "GET /api/v1/leads/14 HTTP/1.1" 200 OK
2026-02-23 09:17:00,063 [INFO] app.core.middleware: Request started: GET /api/v1/leads/14/notes
2026-02-23 09:17:00,067 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/14/notes - 200
INFO:     127.0.0.1:63247 - "GET /api/v1/leads/14/notes HTTP/1.1" 200 OK
2026-02-23 09:17:01,899 [INFO] app.core.middleware: Request started: GET /api/v1/leads/14
2026-02-23 09:17:01,904 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/14 - 200
INFO:     127.0.0.1:63249 - "GET /api/v1/leads/14 HTTP/1.1" 200 OK
2026-02-23 09:17:04,775 [INFO] app.core.middleware: Request started: GET /api/v1/leads/14
2026-02-23 09:17:04,778 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/14 - 200
INFO:     127.0.0.1:63251 - "GET /api/v1/leads/14 HTTP/1.1" 200 OK
2026-02-23 09:17:10,486 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/14/stage
2026-02-23 09:17:10,491 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/14/stage - 400
INFO:     127.0.0.1:63253 - "PATCH /api/v1/leads/14/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:17:11,944 [INFO] app.core.middleware: Request started: GET /api/v1/leads/14
2026-02-23 09:17:11,949 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/14 - 200
INFO:     127.0.0.1:63255 - "GET /api/v1/leads/14 HTTP/1.1" 200 OK
2026-02-23 09:17:13,431 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/14/stage
2026-02-23 09:17:13,435 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/14/stage - 400
INFO:     127.0.0.1:63257 - "PATCH /api/v1/leads/14/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:17:15,324 [INFO] app.core.middleware: Request started: GET /api/v1/leads/14
2026-02-23 09:17:15,326 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/14 - 200
INFO:     127.0.0.1:63259 - "GET /api/v1/leads/14 HTTP/1.1" 200 OK
2026-02-23 09:17:16,723 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/14/stage
2026-02-23 09:17:16,727 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/14/stage - 400
INFO:     127.0.0.1:63271 - "PATCH /api/v1/leads/14/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:38:08,516 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:38:08,580 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63671 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:38:08,588 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:38:08,597 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63673 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:38:17,429 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:38:17,436 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63676 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:38:18,979 [INFO] app.core.middleware: Request started: POST /api/v1/leads
2026-02-23 09:38:19,018 [INFO] app.core.middleware: Request completed: POST /api/v1/leads - 201
INFO:     127.0.0.1:63678 - "POST /api/v1/leads HTTP/1.1" 201 Created
2026-02-23 09:38:24,181 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:38:24,187 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63680 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:38:26,029 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:38:26,034 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:63682 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:38:30,987 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:38:30,991 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:63684 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:38:32,829 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/16
2026-02-23 09:38:32,834 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/16 - 200
INFO:     127.0.0.1:63686 - "PATCH /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:38:32,905 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:38:32,908 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:63688 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:38:34,163 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:38:34,166 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:63690 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:38:39,554 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:38:39,565 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:63692 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:38:40,929 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:38:40,934 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:63694 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:38:43,321 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/16/stage
2026-02-23 09:38:43,326 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/16/stage - 400
INFO:     127.0.0.1:63700 - "PATCH /api/v1/leads/16/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:38:44,773 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:38:44,776 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:63702 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:38:46,858 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16/notes
2026-02-23 09:38:46,866 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16/notes - 200
INFO:     127.0.0.1:63704 - "GET /api/v1/leads/16/notes HTTP/1.1" 200 OK
2026-02-23 09:39:07,339 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:39:07,352 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63717 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:39:09,994 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:39:09,999 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63719 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:43:34,239 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:43:34,310 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:63776 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:54:04,605 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:54:04,622 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64033 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:54:05,834 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:05,838 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64035 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:08,969 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:08,972 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64037 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:10,226 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/16/stage
2026-02-23 09:54:10,244 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/16/stage - 200
INFO:     127.0.0.1:64039 - "PATCH /api/v1/leads/16/stage HTTP/1.1" 200 OK
2026-02-23 09:54:10,318 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:10,321 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64041 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:12,625 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:12,628 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64043 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:13,878 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/16/stage
2026-02-23 09:54:13,881 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/16/stage - 400
INFO:     127.0.0.1:64045 - "PATCH /api/v1/leads/16/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:54:15,695 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:15,697 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64047 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:18,226 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/16/stage
2026-02-23 09:54:18,231 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/16/stage - 400
INFO:     127.0.0.1:64050 - "PATCH /api/v1/leads/16/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:54:19,486 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:19,488 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64052 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:20,773 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/16/stage
2026-02-23 09:54:20,777 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/16/stage - 400
INFO:     127.0.0.1:64054 - "PATCH /api/v1/leads/16/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:54:21,899 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:21,901 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64056 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:23,275 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:23,277 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64058 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:24,300 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/16
2026-02-23 09:54:24,304 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/16 - 200
INFO:     127.0.0.1:64060 - "PATCH /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:24,370 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:24,372 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64062 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:25,522 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:25,524 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64064 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:28,449 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:28,452 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64066 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:29,522 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:29,524 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64068 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:39,684 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:39,688 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64071 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:54:42,446 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 09:54:42,449 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64077 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 09:59:21,121 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 09:59:21,133 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64123 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 09:59:24,498 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:59:24,500 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64125 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:59:27,361 [INFO] app.core.middleware: Request started: POST /api/v1/leads/15/analyze
2026-02-23 09:59:27,411 [INFO] app.core.middleware: Request completed: POST /api/v1/leads/15/analyze - 200
INFO:     127.0.0.1:64127 - "POST /api/v1/leads/15/analyze HTTP/1.1" 200 OK
2026-02-23 09:59:32,471 [INFO] app.core.middleware: Request started: POST /api/v1/leads/15/analyze
2026-02-23 09:59:32,483 [INFO] app.core.middleware: Request completed: POST /api/v1/leads/15/analyze - 200
INFO:     127.0.0.1:64129 - "POST /api/v1/leads/15/analyze HTTP/1.1" 200 OK
2026-02-23 09:59:34,878 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15/notes
2026-02-23 09:59:34,883 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15/notes - 200
INFO:     127.0.0.1:64132 - "GET /api/v1/leads/15/notes HTTP/1.1" 200 OK
2026-02-23 09:59:36,067 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:59:36,069 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64134 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:59:37,234 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:59:37,237 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64136 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:59:38,956 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:59:38,958 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64138 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:59:40,411 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:59:40,414 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64140 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:59:44,402 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15
2026-02-23 09:59:44,408 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15 - 200
INFO:     127.0.0.1:64142 - "PATCH /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:59:44,479 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:59:44,482 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64144 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:59:45,933 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:59:45,936 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64146 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:59:50,091 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 09:59:50,098 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:64148 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:59:51,466 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:59:51,468 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64150 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:59:52,906 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/15/stage
2026-02-23 09:59:52,910 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/15/stage - 400
INFO:     127.0.0.1:64152 - "PATCH /api/v1/leads/15/stage HTTP/1.1" 400 Bad Request
2026-02-23 09:59:54,540 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:59:54,543 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64154 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 09:59:59,408 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 09:59:59,414 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64156 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 10:00:00,427 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 10:00:00,430 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64158 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 10:00:05,897 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 10:00:05,900 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64164 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 10:00:09,121 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:00:09,129 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64166 - "GET /api/v1/leads?source=partner HTTP/1.1" 200 OK
2026-02-23 10:00:32,942 [INFO] app.core.middleware: Request started: GET /api/v1/sales
2026-02-23 10:00:32,948 [INFO] app.core.middleware: Request completed: GET /api/v1/sales - 200
INFO:     127.0.0.1:64170 - "GET /api/v1/sales?stage=KYC HTTP/1.1" 200 OK
2026-02-23 10:00:35,709 [INFO] app.core.middleware: Request started: GET /api/v1/sales
2026-02-23 10:00:35,718 [ERROR] app.core.middleware: Unhandled error: GET /api/v1/sales
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1647, in _object_value_for_elem
    return self._object_lookup[elem]
           ~~~~~~~~~~~~~~~~~~~^^^^^^
KeyError: 'WEB'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/middleware.py", line 77, in dispatch
    )
     
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/contextlib.py", line 222, in __aexit__
    await self.gen.athrow(typ, value, traceback)
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/database.py", line 55, in get_db
    yield session
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 243, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/api/v1/sales.py", line 47, in list_sales
    # CRUD
          
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/repositories/sale_repo.py", line 71, in get_all
    result = await self.db.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 455, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 202, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 244, in chunks
    post_load.invoke(context, path)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 1541, in invoke
    loader(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3197, in _load_for_path
    self._load_via_child(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3228, in _load_via_child
    for k, v in context.session.execute(
                ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 217, in chunks
    fetch = cursor._raw_all_rows()
            ^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in _raw_all_rows
    return [make_row(row) for row in rows]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in <listcomp>
    return [make_row(row) for row in rows]
            ^^^^^^^^^^^^^
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 22, in sqlalchemy.cyextension.resultproxy.BaseRow.__init__
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 79, in sqlalchemy.cyextension.resultproxy._apply_processors
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1767, in process
    value = self._object_value_for_elem(value)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1649, in _object_value_for_elem
    raise LookupError(
LookupError: 'WEB' is not among the defined enum values. Enum name: leadsource. Possible values: SCANNER, PARTNER, MANUAL
2026-02-23 10:00:35,727 [INFO] app.core.middleware: Request completed: GET /api/v1/sales - 500
INFO:     127.0.0.1:64172 - "GET /api/v1/sales HTTP/1.1" 500 Internal Server Error
2026-02-23 10:00:37,444 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:00:37,449 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64174 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:00:58,203 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:00:58,207 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 422
INFO:     127.0.0.1:64176 - "GET /api/v1/leads?stage=qualified HTTP/1.1" 422 Unprocessable Entity
2026-02-23 10:01:05,227 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:01:05,232 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64178 - "GET /api/v1/leads?source=manual HTTP/1.1" 200 OK
2026-02-23 10:01:15,119 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:01:15,125 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64180 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:01:22,964 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:01:22,966 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64183 - "GET /api/v1/leads?source=scanner HTTP/1.1" 200 OK
2026-02-23 10:01:25,944 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:01:25,949 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64185 - "GET /api/v1/leads?business_domain=second HTTP/1.1" 200 OK
2026-02-23 10:01:29,213 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:01:29,219 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64187 - "GET /api/v1/leads?business_domain=first HTTP/1.1" 200 OK
2026-02-23 10:01:33,822 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:01:33,824 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 422
INFO:     127.0.0.1:64189 - "GET /api/v1/leads?stage=new HTTP/1.1" 422 Unprocessable Entity
2026-02-23 10:02:07,345 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:02:07,352 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64192 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:02:13,856 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 10:02:13,859 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64194 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 10:02:20,874 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:02:20,882 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64201 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:02:30,735 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:02:30,742 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64203 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:02:32,307 [INFO] app.core.middleware: Request started: GET /api/v1/leads/12
2026-02-23 10:02:32,310 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/12 - 200
INFO:     127.0.0.1:64205 - "GET /api/v1/leads/12 HTTP/1.1" 200 OK
2026-02-23 10:02:35,371 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/12/stage
2026-02-23 10:02:35,378 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/12/stage - 400
INFO:     127.0.0.1:64207 - "PATCH /api/v1/leads/12/stage HTTP/1.1" 400 Bad Request
2026-02-23 10:02:37,027 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/12/stage
2026-02-23 10:02:37,032 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/12/stage - 400
INFO:     127.0.0.1:64209 - "PATCH /api/v1/leads/12/stage HTTP/1.1" 400 Bad Request
2026-02-23 10:02:45,632 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:02:45,640 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64211 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:02:50,221 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:02:50,225 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64213 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:04:46,758 [INFO] app.core.middleware: Request started: POST /api/v1/leads
2026-02-23 10:04:46,784 [INFO] app.core.middleware: Request completed: POST /api/v1/leads - 201
INFO:     127.0.0.1:64269 - "POST /api/v1/leads HTTP/1.1" 201 Created
2026-02-23 10:04:50,656 [INFO] app.core.middleware: Request started: GET /api/v1/dashboard
2026-02-23 10:04:50,684 [ERROR] app.core.middleware: Unhandled error: GET /api/v1/dashboard
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1647, in _object_value_for_elem
    return self._object_lookup[elem]
           ~~~~~~~~~~~~~~~~~~~^^^^^^
KeyError: 'WEB'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/middleware.py", line 77, in dispatch
    )
     
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/contextlib.py", line 222, in __aexit__
    await self.gen.athrow(typ, value, traceback)
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/database.py", line 55, in get_db
    yield session
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 243, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/api/v1/dashboard.py", line 75, in get_dashboard
    sales, _ = await sale_repo.get_all()
               ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/repositories/sale_repo.py", line 71, in get_all
    result = await self.db.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 455, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 202, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 244, in chunks
    post_load.invoke(context, path)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 1541, in invoke
    loader(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3197, in _load_for_path
    self._load_via_child(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3228, in _load_via_child
    for k, v in context.session.execute(
                ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 217, in chunks
    fetch = cursor._raw_all_rows()
            ^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in _raw_all_rows
    return [make_row(row) for row in rows]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in <listcomp>
    return [make_row(row) for row in rows]
            ^^^^^^^^^^^^^
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 22, in sqlalchemy.cyextension.resultproxy.BaseRow.__init__
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 79, in sqlalchemy.cyextension.resultproxy._apply_processors
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1767, in process
    value = self._object_value_for_elem(value)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1649, in _object_value_for_elem
    raise LookupError(
LookupError: 'WEB' is not among the defined enum values. Enum name: leadsource. Possible values: SCANNER, PARTNER, MANUAL
2026-02-23 10:04:50,686 [INFO] app.core.middleware: Request completed: GET /api/v1/dashboard - 500
INFO:     127.0.0.1:64271 - "GET /api/v1/dashboard HTTP/1.1" 500 Internal Server Error
2026-02-23 10:04:50,694 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:04:50,710 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64275 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:04:59,525 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:04:59,533 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64277 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:05:04,363 [INFO] app.core.middleware: Request started: GET /api/v1/leads/17
2026-02-23 10:05:04,366 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/17 - 200
INFO:     127.0.0.1:64279 - "GET /api/v1/leads/17 HTTP/1.1" 200 OK
2026-02-23 10:05:10,358 [INFO] app.core.middleware: Request started: POST /api/v1/leads/17/analyze
2026-02-23 10:05:10,372 [WARNING] app.ai.ai_service: Redis unavailable, caching disabled: Error 61 connecting to localhost:6379. 61.
2026-02-23 10:05:10,744 [INFO] httpx: HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 401 Unauthorized"
2026-02-23 10:05:10,748 [WARNING] app.ai.ai_service: OpenAI unavailable for lead 17, using rule-based fallback: Error code: 401 - {'error': {'message': 'Incorrect API key provided: sk-proj-********************************************************************************************************************************************************PFIA. You can find your API key at https://platform.openai.com/account/api-keys.', 'type': 'invalid_request_error', 'code': 'invalid_api_key', 'param': None}, 'status': 401}
2026-02-23 10:05:10,752 [INFO] app.core.middleware: Request completed: POST /api/v1/leads/17/analyze - 200
INFO:     127.0.0.1:64281 - "POST /api/v1/leads/17/analyze HTTP/1.1" 200 OK
2026-02-23 10:06:17,685 [INFO] app.core.middleware: Request started: GET /api/v1/leads/17
2026-02-23 10:06:17,695 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/17 - 200
INFO:     127.0.0.1:64297 - "GET /api/v1/leads/17 HTTP/1.1" 200 OK
2026-02-23 10:10:41,316 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:10:41,341 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64376 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:10:47,122 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:10:47,131 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64384 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:12:29,173 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:12:29,185 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64412 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:12:43,575 [INFO] app.core.middleware: Request started: GET /api/v1/sales
2026-02-23 10:12:43,581 [ERROR] app.core.middleware: Unhandled error: GET /api/v1/sales
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1647, in _object_value_for_elem
    return self._object_lookup[elem]
           ~~~~~~~~~~~~~~~~~~~^^^^^^
KeyError: 'WEB'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/middleware.py", line 77, in dispatch
    )
     
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 168, in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/base.py", line 144, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/contextlib.py", line 222, in __aexit__
    await self.gen.athrow(typ, value, traceback)
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/core/database.py", line 55, in get_db
    yield session
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/fastapi/routing.py", line 243, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/api/v1/sales.py", line 47, in list_sales
    # CRUD
          
  File "/Users/nikolas/Documents/ТЗ : Ascend Edge Ltd/TZ---AEL/app/repositories/sale_repo.py", line 71, in get_all
    result = await self.db.execute(query)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/ext/asyncio/session.py", line 455, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 202, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 244, in chunks
    post_load.invoke(context, path)
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 1541, in invoke
    loader(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3197, in _load_for_path
    self._load_via_child(
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/strategies.py", line 3228, in _load_via_child
    for k, v in context.session.execute(
                ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2308, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2190, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 296, in orm_execute_statement
    return cls.orm_setup_cursor_result(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/context.py", line 589, in orm_setup_cursor_result
    return loading.instances(result, querycontext)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 259, in instances
    _prebuffered = list(chunks(None))
                   ^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/orm/loading.py", line 217, in chunks
    fetch = cursor._raw_all_rows()
            ^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in _raw_all_rows
    return [make_row(row) for row in rows]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/engine/result.py", line 544, in <listcomp>
    return [make_row(row) for row in rows]
            ^^^^^^^^^^^^^
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 22, in sqlalchemy.cyextension.resultproxy.BaseRow.__init__
  File "lib/sqlalchemy/cyextension/resultproxy.pyx", line 79, in sqlalchemy.cyextension.resultproxy._apply_processors
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1767, in process
    value = self._object_value_for_elem(value)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/sqlalchemy/sql/sqltypes.py", line 1649, in _object_value_for_elem
    raise LookupError(
LookupError: 'WEB' is not among the defined enum values. Enum name: leadsource. Possible values: SCANNER, PARTNER, MANUAL
2026-02-23 10:12:43,584 [INFO] app.core.middleware: Request completed: GET /api/v1/sales - 500
INFO:     127.0.0.1:64415 - "GET /api/v1/sales HTTP/1.1" 500 Internal Server Error
2026-02-23 10:13:46,545 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:13:46,572 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64433 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:13:55,914 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:13:55,925 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64437 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:13:56,956 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 10:13:56,959 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64439 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 10:13:58,171 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/16/stage
2026-02-23 10:13:58,176 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/16/stage - 400
INFO:     127.0.0.1:64441 - "PATCH /api/v1/leads/16/stage HTTP/1.1" 400 Bad Request
2026-02-23 10:13:59,808 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/16/stage
2026-02-23 10:13:59,812 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/16/stage - 400
INFO:     127.0.0.1:64443 - "PATCH /api/v1/leads/16/stage HTTP/1.1" 400 Bad Request
2026-02-23 10:14:00,787 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 10:14:00,791 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64445 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 10:14:09,377 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:14:09,384 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64448 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:14:30,352 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:14:30,360 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64458 - "GET /api/v1/leads?business_domain=second HTTP/1.1" 200 OK
2026-02-23 10:14:33,008 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:14:33,013 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64460 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:14:35,287 [INFO] app.core.middleware: Request started: GET /api/v1/leads/14
2026-02-23 10:14:35,290 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/14 - 200
INFO:     127.0.0.1:64464 - "GET /api/v1/leads/14 HTTP/1.1" 200 OK
2026-02-23 10:14:37,668 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/14/stage
2026-02-23 10:14:37,675 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/14/stage - 400
INFO:     127.0.0.1:64466 - "PATCH /api/v1/leads/14/stage HTTP/1.1" 400 Bad Request
2026-02-23 10:14:39,111 [INFO] app.core.middleware: Request started: GET /api/v1/leads/14
2026-02-23 10:14:39,114 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/14 - 200
INFO:     127.0.0.1:64469 - "GET /api/v1/leads/14 HTTP/1.1" 200 OK
2026-02-23 10:27:48,143 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:27:48,173 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64640 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:27:50,835 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 10:27:50,839 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64643 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 10:27:52,264 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 10:27:52,267 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64645 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 10:27:53,651 [INFO] app.core.middleware: Request started: PATCH /api/v1/leads/16/stage
2026-02-23 10:27:53,658 [INFO] app.core.middleware: Request completed: PATCH /api/v1/leads/16/stage - 400
INFO:     127.0.0.1:64647 - "PATCH /api/v1/leads/16/stage HTTP/1.1" 400 Bad Request
2026-02-23 10:27:54,855 [INFO] app.core.middleware: Request started: GET /api/v1/leads/16
2026-02-23 10:27:54,858 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/16 - 200
INFO:     127.0.0.1:64649 - "GET /api/v1/leads/16 HTTP/1.1" 200 OK
2026-02-23 10:27:55,718 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:27:55,722 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64652 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:28:25,749 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:28:25,755 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64670 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:29:11,017 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:29:11,030 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64683 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:29:14,947 [INFO] app.core.middleware: Request started: GET /api/v1/leads
2026-02-23 10:29:14,953 [INFO] app.core.middleware: Request completed: GET /api/v1/leads - 200
INFO:     127.0.0.1:64686 - "GET /api/v1/leads HTTP/1.1" 200 OK
2026-02-23 10:29:16,007 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15
2026-02-23 10:29:16,010 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15 - 200
INFO:     127.0.0.1:64688 - "GET /api/v1/leads/15 HTTP/1.1" 200 OK
2026-02-23 10:29:20,986 [INFO] app.core.middleware: Request started: GET /api/v1/leads/15/notes
2026-02-23 10:29:20,995 [INFO] app.core.middleware: Request completed: GET /api/v1/leads/15/notes - 200
INFO:     127.0.0.1:64693 - "GET /api/v1/leads/15/notes HTTP/1.1" 200 OK
